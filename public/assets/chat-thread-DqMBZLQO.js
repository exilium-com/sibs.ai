var L=Object.defineProperty;var q=(h,c,e)=>c in h?L(h,c,{enumerable:!0,configurable:!0,writable:!0,value:e}):h[c]=e;var g=(h,c,e)=>(q(h,typeof c!="symbol"?c+"":c,e),e);import{d as F,r,b as s,c as l,w as d,y,A as m,e as p,f as U,g as S,z as H,x as f,R as $,m as j,l as P,S as J,v as D,a as Q,G as t,n as W,C as X,F as R,B as z,T as Y,D as Z,E as ee,U as te,V as se,I as ae,k as ne}from"./main-CuD3QBrw.js";import{R as ie}from"./index-CluUaWoL.js";import{R as oe}from"./rating-popup-CE0OOCdk.js";const ce={key:0,class:"py-1 pe-1"},le={class:"py-0 py-md-1",style:{"min-width":"30%"}},re=U("i",{class:"fa-solid fa-ellipsis fa-beat-fade fa-lg"},null,-1),de={class:"small"},ue={class:"d-flex justify-space-between px-4 align-baseline"},me={key:1},he={key:1,class:"py-1 ps-1"},O=F({__name:"chat-message",props:{skeleton:{type:Boolean},message:{},time:{},isMine:{},rating:{},comment:{},messageIndex:{}},setup(h){const c=h;if(isNaN(c.messageIndex))throw new Error("Message requires a numeric key");return(e,u)=>{const n=r("v-skeleton-loader"),C=r("v-container"),M=r("v-icon"),w=r("v-avatar"),b=r("v-card-text"),x=r("v-card");return e.skeleton?(s(),l(C,{key:0},{default:d(()=>[e.isMine?(s(),l(n,{key:0,type:"avatar, paragraph",class:"flex-row-reverse"})):y("",!0),e.isMine?y("",!0):(s(),l(n,{key:1,type:"avatar, sentences"}))]),_:1})):(s(),m("div",{key:1,class:$(["d-flex",{"justify-end":e.isMine,"justify-start":!e.isMine}])},[e.isMine?(s(),m("div",ce,[p(w,{color:"primary"},{default:d(()=>[p(M,{icon:"mdi-account"})]),_:1})])):y("",!0),U("div",le,[p(x,{class:$(["mb-4",{"bg-primary-surface":e.isMine,"bg-secondary-surface":!e.isMine}])},{default:d(()=>[e.message==="…"&&!e.isMine?(s(),l(b,{key:0},{default:d(()=>[re]),_:1})):(s(),l(b,{key:1,class:"pa-2 px-4"},{default:d(()=>[S(H(e.message),1)]),_:1})),U("div",de,[U("div",ue,[e.isMine?(s(),m("span",me)):(s(),l(oe,{key:0,initialRating:e.rating,initialComment:e.comment,messageIndex:c.messageIndex},null,8,["initialRating","initialComment","messageIndex"])),e.time?(s(),l(f(ie),{key:2,class:"text-grey small",time:new Date(e.time),locale:null},null,8,["time"])):y("",!0)])])]),_:1},8,["class"])]),e.isMine?y("",!0):(s(),m("div",he,[p(w,{color:"secondary"},{default:d(()=>[p(M,{icon:"mdi-robot"})]),_:1})]))],2))}}});class pe{constructor(c,e,u){g(this,"timeoutId",null);g(this,"timeoutMs");g(this,"userCallback");g(this,"maxConsecutiveIdleCalls");g(this,"boundInternalCallback");g(this,"consecutiveIdleCalls",0);this.timeoutMs=c,this.userCallback=u,this.maxConsecutiveIdleCalls=e,this.boundInternalCallback=this.internalCallback.bind(this),this.reset()}internalCallback(){this.consecutiveIdleCalls++,this.timeoutId=0,this.userCallback()}reset(){this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=0,this.consecutiveIdleCalls=0),!(this.consecutiveIdleCalls>=this.maxConsecutiveIdleCalls)&&(this.timeoutId=setTimeout(this.boundInternalCallback,this.timeoutMs))}clear(){this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=0)}}const ye={key:0,class:"alert alert-primary",role:"alert"},_e={key:0,class:"py-2 px-2 px-md-3"},ge={key:1,class:"py-2 px-2 px-md-3"},fe=F({__name:"chat-thread",props:{chatId:{},readOnly:{type:Boolean}},emits:["summaryNeedsUpdate"],setup(h,{emit:c}){const e=h,u=j(),n=P({inputControl:null,typedMessage:"",pendingResponse:!1,invalidChatId:!1}),C=new pe(6e4,2,()=>{console.log("idleTimeout - pinging user"),V()});J(()=>{C.clear()}),D(()=>[u.currentAccount,e.chatId],async(o,i)=>{u.currentAccount&&(console.log("chat-thread: watch: chatId changed",o,i),await te(u.currentAccount.id,e.chatId)&&t.chat?(u.chatId=e.chatId,t.chat.messages.length==0&&V(),await A(),x()):n.invalidChatId=!0)},{immediate:!0}),D(()=>e.readOnly,async(o,i)=>{console.log("chat-thread: watch: readonly =",o,i)},{immediate:!0});const M=Q();D(()=>u.currentAccount,(o,i)=>{console.log("chat-thread: currentAccount changed",o,i),u.currentAccount&&!u.isCurrentAccountMine()&&u.currentAccount.role=="admin"&&M.push({name:"chats"})},{immediate:!0});const w=c;let b=[{key:0,isMine:!1},{key:1,isMine:!0},{key:2,isMine:!1},{key:3,isMine:!0},{key:4,isMine:!1},{key:5,isMine:!0},{key:6,isMine:!1},{key:7,isMine:!0},{key:8,isMine:!1}];function x(){t.chat&&t.chat._id&&se(t.chat)&&(console.log("EmitNeedsUpdateIfNeeded: emitting summary needs update, chatId = ",t.chat._id,"chat =",t.chat),w("summaryNeedsUpdate"),t.dirtyChatsMetadata.add(t.chat._id))}async function A(){await ae(),window.scrollTo(0,document.body.scrollHeight)}async function V(o){var N;if(!t.chat)return;console.log("getAIAnswer",e.chatId,"userMessage=",o);const i=j();if(!i.currentAccount){console.error("no current account");return}o&&(t.chat.messages.push({content:o,timestamp:new Date().toISOString(),type:"User",key:t.chat.messages.length}),n.typedMessage=""),n.pendingResponse=!0;let k={content:"…",timestamp:"",type:"AI",key:t.chat.messages.length};t.chat.messages.push(k),await A();const B=o?"/api/chat/{account_id}/{chat_id}":t.chat.messages.length>1?"/api/chat/{account_id}/{chat_id}/ping":"/api/chat/{account_id}/{chat_id}/initial",{data:v,error:T}=await W(B,{params:{path:{account_id:i.currentAccount.id,chat_id:e.chatId}},body:{content:o??""}});T&&console.error(T),n.pendingResponse=!1,v&&(t.chat.messages[k.key].timestamp=new Date(v.message.timestamp).toISOString(),t.chat.messages[k.key].content=v.message.content,t.chat={_id:t.chat._id,...v.metadata,messages:t.chat.messages}),await A(),(N=n.inputControl)==null||N.focus(),x(),C.reset()}async function E(){var o,i;if(console.log("sendMessage"),((o=n.inputControl)==null?void 0:o.value)===""){console.log("sendMessage empty, ignoring.");return}V((i=n.inputControl)==null?void 0:i.value)}return(o,i)=>{const k=r("router-link"),B=r("v-expand-transition"),v=r("v-icon"),T=r("v-text-field"),N=r("v-container"),G=r("v-footer"),K=X("focus");return s(),m(R,null,[n.invalidChatId?(s(),m("div",ye,[S(" This chat does not exist, maybe you should look in "),p(k,{to:"/chats"},{default:d(()=>[S("all chats")]),_:1}),S(". ")])):y("",!0),p(B,null,{default:d(()=>[f(t).chat?(s(),m("div",_e,[f(t).chat?(s(),l(Y,{key:0,name:"grow"},{default:d(()=>[(s(!0),m(R,null,z(f(t).chat.messages,a=>{var I,_;return s(),m(R,null,[a.type==="AI"?(s(),l(O,{message:a.content,time:a.timestamp,key:a.key,isMine:!1,messageIndex:a.key,rating:(I=a.rating)==null?void 0:I.rating,comment:((_=a.rating)==null?void 0:_.comment)??""},null,8,["message","time","messageIndex","rating","comment"])):(s(),l(O,{message:a.content,time:a.timestamp,key:-a.key,isMine:!0,messageIndex:a.key},null,8,["message","time","messageIndex"]))],64)}),256))]),_:1})):y("",!0)])):(s(),m("div",ge,[(s(!0),m(R,null,z(f(b),a=>(s(),l(O,{skeleton:"",key:a.key,isMine:a.isMine,messageIndex:a.key},null,8,["isMine","messageIndex"]))),128))]))]),_:1}),p(G,{app:"",color:"surface-darken-1"},{default:d(()=>[p(N,{class:"v-col-sm-9 v-col-lg-6 pa-0"},{default:d(()=>{var a,I;return[Z((s(),l(T,{ref:_=>{n.inputControl=_},"hide-details":"",modelValue:n.typedMessage,"onUpdate:modelValue":i[0]||(i[0]=_=>n.typedMessage=_),density:"compact",variant:"outlined",placeholder:(a=f(t).chat)!=null&&a.closed?"Chat closed":e.readOnly?"":"Type message here",disabled:n.pendingResponse||e.readOnly||((I=f(t).chat)==null?void 0:I.closed),onClick:i[1]||(i[1]=_=>A()),onKeydown:ee(E,["enter"])},{"append-inner":d(()=>[n.typedMessage.length>0?(s(),l(v,{key:0,icon:"mdi-send-variant",color:"primary",onClick:E})):y("",!0)]),_:1},8,["modelValue","placeholder","disabled"])),[[K]])]}),_:1})]),_:1})],64)}}}),Me=ne(fe,[["__scopeId","data-v-f8d4c53d"]]);export{Me as C};
