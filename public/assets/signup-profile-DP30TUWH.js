import{q as Q,ax as Z,bu as ee,t as te,az as oe,v as ae,aG as le,ad as x,y as R,ag as ne,z as Y,C as ie,A as re,ak as ue,e as t,Y as se,E as L,D as de,b6 as me,bB as W,d as ce,u as fe,a as pe,J as ve,l as p,H as ye,c as O,w as n,V as H,b as w,bn as ge,T as m,aO as be,h as C,W as I,U as he,R as U,P as z,g as G,j as Ve,f as S,bo as xe,K as _e,M as Ce,bC as Te}from"./main-J1mwJ8PB.js";import{r as k}from"./form-validation-Bhn6uNEO.js";import{_ as ke,a as Ee}from"./date-field.vue_vue_type_script_setup_true_lang-DMUKa1HF.js";import{V as Ne,_ as Se,a as Fe}from"./primary-button.vue_vue_type_script_setup_true_lang-DJ8OUvR1.js";import{V as D}from"./VRow-BjIh_6hr.js";import{V as T}from"./VCol-8t7F6D9y.js";import{b as Oe,c as we,d as De,e as Pe,V as j}from"./VTextField-BRxBEl6s.js";const Be=Q({autofocus:Boolean,divider:String,focusAll:Boolean,label:{type:String,default:"$vuetify.input.otp"},length:{type:[Number,String],default:6},modelValue:{type:[Number,String],default:void 0},placeholder:String,type:{type:String,default:"number"},...Z(),...Oe(),...ee(we({variant:"outlined"}),["baseColor","bgColor","class","color","disabled","error","loading","rounded","style","theme","variant"])},"VOtpInput"),Me=te()({name:"VOtpInput",props:Be(),emits:{finish:a=>!0,"update:focused":a=>!0,"update:modelValue":a=>!0},setup(a,u){let{attrs:$,emit:y,slots:h}=u;const{dimensionStyles:e}=oe(a),{isFocused:P,focus:q,blur:B}=De(a),c=ae(a,"modelValue","",o=>o==null?[]:String(o).split(""),o=>o.join("")),{t:M}=le(),E=x(()=>Number(a.length)),A=x(()=>Array(E.value).fill(0)),f=R(-1),N=R(),r=R([]),l=x(()=>r.value[f.value]);function V(){if(K(l.value.value)){l.value.value="";return}const o=c.value.slice(),s=l.value.value;o[f.value]=s;let g=null;f.value>c.value.length?g=c.value.length+1:f.value+1!==E.value&&(g="next"),c.value=o,g&&W(N.value,g)}function i(o){const s=c.value.slice(),g=f.value;let b=null;["ArrowLeft","ArrowRight","Backspace","Delete"].includes(o.key)&&(o.preventDefault(),o.key==="ArrowLeft"?b="prev":o.key==="ArrowRight"?b="next":["Backspace","Delete"].includes(o.key)&&(s[f.value]="",c.value=s,f.value>0&&o.key==="Backspace"?b="prev":requestAnimationFrame(()=>{var d;(d=r.value[g])==null||d.select()})),requestAnimationFrame(()=>{b!=null&&W(N.value,b)}))}function _(o,s){var b,d;s.preventDefault(),s.stopPropagation();const g=((b=s==null?void 0:s.clipboardData)==null?void 0:b.getData("Text"))??"";K(g)||(c.value=g.split(""),(d=r.value)==null||d[o].blur())}function v(){c.value=[]}function J(o,s){q(),f.value=s}function X(){B(),f.value=-1}function K(o){return a.type==="number"&&/[^0-9]/g.test(o)}return ne({VField:{color:x(()=>a.color),bgColor:x(()=>a.color),baseColor:x(()=>a.baseColor),disabled:x(()=>a.disabled),error:x(()=>a.error),variant:x(()=>a.variant)}},{scoped:!0}),Y(c,o=>{o.length===E.value&&y("finish",o.join(""))},{deep:!0}),Y(f,o=>{o<0||ie(()=>{var s;(s=r.value[o])==null||s.select()})}),re(()=>{var g;const[o,s]=ue($);return t("div",L({class:["v-otp-input",{"v-otp-input--divided":!!a.divider},a.class],style:[a.style]},o),[t("div",{ref:N,class:"v-otp-input__content",style:[e.value]},[A.value.map((b,d)=>t(se,null,[a.divider&&d!==0&&t("span",{class:"v-otp-input__divider"},[a.divider]),t(Pe,{focused:P.value&&a.focusAll||f.value===d,key:d},{...h,loader:void 0,default:()=>t("input",{ref:F=>r.value[d]=F,"aria-label":M(a.label,d+1),autofocus:d===0&&a.autofocus,autocomplete:"one-time-code",class:["v-otp-input__field"],disabled:a.disabled,inputmode:a.type==="number"?"numeric":"text",min:a.type==="number"?0:void 0,maxlength:"1",placeholder:a.placeholder,type:a.type==="number"?"text":a.type,value:c.value[d],onInput:V,onFocus:F=>J(F,d),onBlur:X,onKeydown:i,onPaste:F=>_(d,F)},null)})])),t("input",L({class:"v-otp-input-input",type:"hidden"},s,{value:c.value.join("")}),null),t(de,{contained:!0,"content-class":"v-otp-input__loader","model-value":!!a.loading,persistent:!0},{default:()=>{var b;return[((b=h.loader)==null?void 0:b.call(h))??t(me,{color:typeof a.loading=="boolean"?void 0:a.loading,indeterminate:!0,size:"24",width:"2"},null)]}}),(g=h.default)==null?void 0:g.call(h)])])}),{blur:()=>{var o;(o=r.value)==null||o.some(s=>s.blur())},focus:()=>{var o;(o=r.value)==null||o[0].focus()},reset:v,isFocused:P}}}),Ae=S("br",null,null,-1),Ie={class:"text-grey mt-3"},Ue={class:"text-grey mt-3"},Ye=S("br",null,null,-1),$e=15*60,We=ce({__name:"signup-profile",setup(a){var c,M,E,A,f,N;const{user:u}=fe(),$=pe(),y=ve(),h=x(()=>{var r,l,V;return e.otpVerified||((r=u==null?void 0:u.value)==null?void 0:r.email)&&((l=u==null?void 0:u.value)==null?void 0:l.email_verified)||((V=y.person)==null?void 0:V.validation)==="Verified"});p.debug(p.context(),"person = ",y.person);const e=ye({movingToOtherStep:!1,formOk:!1,myGivenName:((c=y.person)==null?void 0:c.given_name)??"",myFamilyName:((M=y.person)==null?void 0:M.family_name)??"",myEmail:((E=y.person)==null?void 0:E.email)??"",myPhone:((A=y.person)==null?void 0:A.phone)??"",myBirthDate:(f=y.person)!=null&&f.birth_date?new Date((N=y.person)==null?void 0:N.birth_date):void 0,sentCodeCount:0,codeTimeout:void 0,codeTimeoutStep:1,codeExpirationMsg:"",otp:"",otpErrorMsgs:{title:"",text:""},checkingOTP:!1,otpVerified:!1,otpControl:null,formControl:null,resending:!1});Y(()=>e.codeTimeout,async()=>{if(p.debug(p.context(),"codeTimeout changed to ",e.codeTimeout),e.codeTimeout!==void 0)if(e.codeTimeout<=0)p.debug(p.context(),"codeTimeout expired"),e.codeExpirationMsg="That code has expired.",e.codeTimeout=-1;else{if(e.codeTimeout>59){const r=Math.round(e.codeTimeout/60);e.codeExpirationMsg=`Your code will expire in ${r} minute${r>1?"s":""}.`,e.codeTimeoutStep=30}else e.codeExpirationMsg=`Your code will expire in ${e.codeTimeout} seconds.`,e.codeTimeoutStep=1;setTimeout(()=>{e.codeTimeout&&(e.codeTimeout-=e.codeTimeoutStep)},e.codeTimeoutStep*1e3)}},{immediate:!0}),Y(()=>e.otp,()=>{e.otp=e.otp.toUpperCase()});async function P(){var r,l,V,i,_;p.debug(p.context(),"otp changed to ",e.otp);try{e.checkingOTP=!0,(r=e.otpControl)==null||r.blur();const{response:v}=await _e("/api/person/me/verify",{body:{email:(l=u==null?void 0:u.value)!=null&&l.email?null:e.myEmail,code:e.otp}});v.status==200||v.status==204?((V=e.formControl)==null||V.validate(),e.otpVerified=!0):(e.otpErrorMsgs={title:"Invalid code",text:""},(i=e.otpControl)==null||i.reset(),(_=e.otpControl)==null||_.focus())}finally{e.checkingOTP=!1}}function q(){e.movingToOtherStep=!0,Ce("/api/person/me",{body:{given_name:e.myGivenName||void 0,family_name:e.myFamilyName||void 0,birth_date:e.myBirthDate?e.myBirthDate.toISOString().substr(0,10):void 0,phone:e.myPhone||void 0}}).then(()=>{p.debug(p.context(),"going to verify"),$.push({name:"authorized"})}).catch(r=>p.error(p.context(),r)).finally(()=>{e.movingToOtherStep=!1})}async function B(){var r;p.debug(p.context(),"resend");try{e.resending=!0,await Te((r=u==null?void 0:u.value)!=null&&r.email?void 0:e.myEmail)?(e.sentCodeCount++,e.codeTimeout=$e):e.otpErrorMsgs={title:"Error",text:"Failed to send email"}}finally{e.resending=!1}}return(r,l)=>(w(),O(H,{class:"v-col-sm-9 v-col-lg-6 v-col-xl-4 pa-0 mt-4"},{default:n(()=>{var V;return[t(U,null,ge({title:n(()=>[C("About you")]),subtitle:n(()=>{var i;return[C(I((i=m(u))==null?void 0:i.email),1)]}),default:n(()=>[t(Ne,{ref:i=>{e.formControl=i},modelValue:e.formOk,"onUpdate:modelValue":l[9]||(l[9]=i=>e.formOk=i)},{default:n(()=>[t(H,null,{default:n(()=>[t(D,null,{default:n(()=>[t(T,null,{default:n(()=>[t(j,{type:"text",label:"Your first name",id:"myGivenName",modelValue:e.myGivenName,"onUpdate:modelValue":l[0]||(l[0]=i=>e.myGivenName=i),rules:[m(k).required,m(k).name],required:""},null,8,["modelValue","rules"])]),_:1}),t(T,null,{default:n(()=>[t(j,{type:"text",label:"Your last name",id:"myFamilyName",modelValue:e.myFamilyName,"onUpdate:modelValue":l[1]||(l[1]=i=>e.myFamilyName=i),rules:[m(k).required,m(k).name],required:""},null,8,["modelValue","rules"])]),_:1})]),_:1}),t(D,{"no-gutters":""},{default:n(()=>[t(T,null,{default:n(()=>[t(ke,{type:"tel",id:"myPhone",label:"Your phone number",modelValue:e.myPhone,"onUpdate:modelValue":l[2]||(l[2]=i=>e.myPhone=i),help:"Your phone number enables us to enhance our communication. We don't share your phone number with anyone.",rules:[m(k).phoneOrBlank]},null,8,["modelValue","rules"])]),_:1})]),_:1}),t(D,{"no-gutters":""},{default:n(()=>[t(T,null,{default:n(()=>[t(Ee,{label:"Your birth date","min-date":-100*365,"max-date":0,id:"myBirthDate",help:"Your date of birth enables us to enhance our communication. We don't share your date of birth.",date:e.myBirthDate,"onUpdate:date":l[3]||(l[3]=i=>e.myBirthDate=i)},null,8,["date"])]),_:1})]),_:1}),t(D,{"no-gutters":""},{default:n(()=>[t(T,null,{default:n(()=>{var i;return[(i=m(u))!=null&&i.email?he("",!0):(w(),O(j,{key:0,label:"Your email",id:"myEmail",modelValue:e.myEmail,"onUpdate:modelValue":l[4]||(l[4]=_=>e.myEmail=_),rules:[m(k).required,m(k).email]},null,8,["modelValue","rules"])),e.sentCodeCount===0?(w(),O(U,{key:1,variant:"tonal",density:"compact"},{default:n(()=>[t(z,{class:"text-center"},{default:n(()=>[t(G,{icon:"mdi-alert-circle-outline",size:"large"}),C("   Your email is not confirmed yet     "),t(Ve,{disabled:!e.myEmail,class:"mt-4",elevation:"3",variant:"tonal",block:"",onClick:B,loading:e.resending},{default:n(()=>[C("Send email confirmation code")]),_:1},8,["disabled","loading"])]),_:1})]),_:1})):h.value?(w(),O(U,{key:3,variant:"tonal"},{default:n(()=>[t(z,null,{default:n(()=>[t(D,null,{default:n(()=>[t(T,{cols:"auto",class:"align-self-center"},{default:n(()=>[t(G,{icon:"mdi-email-seal",size:"xx-large"})]),_:1}),t(T,{class:"text-left"},{default:n(()=>[S("span",null,I(e.myEmail)+" is confirmed",1),Ye]),_:1}),t(T,{cols:"auto",class:"align-self-center"},{default:n(()=>[t(Fe,{disabled:!e.formOk||!h.value,onClick:q,loading:e.movingToOtherStep},{default:n(()=>[C("Continue")]),_:1},8,["disabled","loading"])]),_:1})]),_:1})]),_:1})]),_:1})):(w(),O(U,{key:2,disabled:!e.myEmail,variant:"tonal",density:"compact"},{default:n(()=>[t(z,{class:"text-center"},{default:n(()=>{var _;return[t(G,{icon:"mdi-email",size:"large"}),C("   Check your email    "),Ae,S("div",Ie," Enter the 6-letter code we sent to "+I((_=m(u))==null?void 0:_.email)+". ",1),t(m(Me),{ref:v=>{e.otpControl=v},autofocus:"",modelValue:e.otp,"onUpdate:modelValue":l[5]||(l[5]=v=>e.otp=v),onFinish:l[6]||(l[6]=v=>P()),loading:e.checkingOTP,type:"text",placeholder:"-"},null,8,["modelValue","loading"]),t(Se,{"error-title":e.otpErrorMsgs.title,"onUpdate:errorTitle":l[7]||(l[7]=v=>e.otpErrorMsgs.title=v),"error-msg":e.otpErrorMsgs.text,"onUpdate:errorMsg":l[8]||(l[8]=v=>e.otpErrorMsgs.text=v)},null,8,["error-title","error-msg"]),S("div",Ue,[C(I(e.codeExpirationMsg)+" If you didn't receive it, please click ",1),S("a",{href:"#",onClick:xe(B,["prevent"])},"here"),C(" to send a new one. ")])]}),_:1})]),_:1},8,["disabled"]))]}),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:2},[(V=m(u))!=null&&V.picture?{name:"prepend",fn:n(()=>{var i;return[t(be,{picture:(i=m(u))==null?void 0:i.picture,firstName:e.myGivenName,lastName:e.myFamilyName,badge:m(y).invitationCount>0?m(y).invitationCount:void 0},null,8,["picture","firstName","lastName","badge"])]}),key:"0"}:void 0]),1024)]}),_:1}))}});export{We as default};
