import{q as Q,ax as Z,bu as ee,t as te,az as ae,v as oe,aG as le,ad as h,y as R,ag as ne,z as U,C as ie,A as re,ak as ue,e as t,Y as se,E as W,D as de,b6 as me,bB as H,d as ce,u as fe,a as pe,J as ve,l as p,H as ye,c as D,w as n,V as J,b as P,bn as ge,T as m,aO as be,h as T,W as q,U as he,R as I,P as z,g as j,j as Ve,f as S,bo as xe,K as _e,M as Ce,bC as Te}from"./main-C-J6Z3r-.js";import{r as E}from"./form-validation-Bhn6uNEO.js";import{_ as ke,a as Ee}from"./date-field.vue_vue_type_script_setup_true_lang-BkcEX3_9.js";import{V as Ne,_ as Fe,a as Se}from"./primary-button.vue_vue_type_script_setup_true_lang-CCtyAB5E.js";import{V as B}from"./VRow-FW63HEHb.js";import{V as k}from"./VCol-BwbjBJsN.js";import{b as Oe,c as we,d as De,e as Pe,V as K}from"./VTextField-Bc-Q8fL1.js";const Be=Q({autofocus:Boolean,divider:String,focusAll:Boolean,label:{type:String,default:"$vuetify.input.otp"},length:{type:[Number,String],default:6},modelValue:{type:[Number,String],default:void 0},placeholder:String,type:{type:String,default:"number"},...Z(),...Oe(),...ee(we({variant:"outlined"}),["baseColor","bgColor","class","color","disabled","error","loading","rounded","style","theme","variant"])},"VOtpInput"),Me=te()({name:"VOtpInput",props:Be(),emits:{finish:o=>!0,"update:focused":o=>!0,"update:modelValue":o=>!0},setup(o,r){let{attrs:Y,emit:y,slots:V}=r;const{dimensionStyles:e}=ae(o),{isFocused:O,focus:$,blur:G}=De(o),c=oe(o,"modelValue","",a=>a==null?[]:String(a).split(""),a=>a.join("")),{t:M}=le(),N=h(()=>Number(o.length)),A=h(()=>Array(N.value).fill(0)),f=R(-1),F=R(),x=R([]),s=h(()=>x.value[f.value]);function l(){if(L(s.value.value)){s.value.value="";return}const a=c.value.slice(),u=s.value.value;a[f.value]=u;let g=null;f.value>c.value.length?g=c.value.length+1:f.value+1!==N.value&&(g="next"),c.value=a,g&&H(F.value,g)}function _(a){const u=c.value.slice(),g=f.value;let b=null;["ArrowLeft","ArrowRight","Backspace","Delete"].includes(a.key)&&(a.preventDefault(),a.key==="ArrowLeft"?b="prev":a.key==="ArrowRight"?b="next":["Backspace","Delete"].includes(a.key)&&(u[f.value]="",c.value=u,f.value>0&&a.key==="Backspace"?b="prev":requestAnimationFrame(()=>{var d;(d=x.value[g])==null||d.select()})),requestAnimationFrame(()=>{b!=null&&H(F.value,b)}))}function i(a,u){var b,d;u.preventDefault(),u.stopPropagation();const g=((b=u==null?void 0:u.clipboardData)==null?void 0:b.getData("Text"))??"";L(g)||(c.value=g.split(""),(d=x.value)==null||d[a].blur())}function C(){c.value=[]}function v(a,u){$(),f.value=u}function X(){G(),f.value=-1}function L(a){return o.type==="number"&&/[^0-9]/g.test(a)}return ne({VField:{color:h(()=>o.color),bgColor:h(()=>o.color),baseColor:h(()=>o.baseColor),disabled:h(()=>o.disabled),error:h(()=>o.error),variant:h(()=>o.variant)}},{scoped:!0}),U(c,a=>{a.length===N.value&&y("finish",a.join(""))},{deep:!0}),U(f,a=>{a<0||ie(()=>{var u;(u=x.value[a])==null||u.select()})}),re(()=>{var g;const[a,u]=ue(Y);return t("div",W({class:["v-otp-input",{"v-otp-input--divided":!!o.divider},o.class],style:[o.style]},a),[t("div",{ref:F,class:"v-otp-input__content",style:[e.value]},[A.value.map((b,d)=>t(se,null,[o.divider&&d!==0&&t("span",{class:"v-otp-input__divider"},[o.divider]),t(Pe,{focused:O.value&&o.focusAll||f.value===d,key:d},{...V,loader:void 0,default:()=>t("input",{ref:w=>x.value[d]=w,"aria-label":M(o.label,d+1),autofocus:d===0&&o.autofocus,autocomplete:"one-time-code",class:["v-otp-input__field"],disabled:o.disabled,inputmode:o.type==="number"?"numeric":"text",min:o.type==="number"?0:void 0,maxlength:"1",placeholder:o.placeholder,type:o.type==="number"?"text":o.type,value:c.value[d],onInput:l,onFocus:w=>v(w,d),onBlur:X,onKeydown:_,onPaste:w=>i(d,w)},null)})])),t("input",W({class:"v-otp-input-input",type:"hidden"},u,{value:c.value.join("")}),null),t(de,{contained:!0,"content-class":"v-otp-input__loader","model-value":!!o.loading,persistent:!0},{default:()=>{var b;return[((b=V.loader)==null?void 0:b.call(V))??t(me,{color:typeof o.loading=="boolean"?void 0:o.loading,indeterminate:!0,size:"24",width:"2"},null)]}}),(g=V.default)==null?void 0:g.call(V)])])}),{blur:()=>{var a;(a=x.value)==null||a.some(u=>u.blur())},focus:()=>{var a;(a=x.value)==null||a[0].focus()},reset:C,isFocused:O}}}),Ae=S("br",null,null,-1),qe={class:"text-grey mt-3"},Ie={class:"text-grey mt-3"},Ue=S("br",null,null,-1),Ye=15*60,We=ce({__name:"signup-profile",setup(o){var M,N,A,f,F,x;const{user:r}=fe(),Y=pe(),y=ve(),V=h(()=>{var s,l,_;return e.otpVerified||((s=r==null?void 0:r.value)==null?void 0:s.email)&&((l=r==null?void 0:r.value)==null?void 0:l.email_verified)||((_=y.person)==null?void 0:_.validation)==="Verified"});p.debug(p.context(),"person = ",y.person);const e=ye({movingToOtherStep:!1,formOk:!1,myGivenName:((M=y.person)==null?void 0:M.given_name)??"",myFamilyName:((N=y.person)==null?void 0:N.family_name)??"",myEmail:((A=y.person)==null?void 0:A.email)??"",myPhone:((f=y.person)==null?void 0:f.phone)??"",myBirthDate:(F=y.person)!=null&&F.birth_date?new Date((x=y.person)==null?void 0:x.birth_date):void 0,sentCodeCount:0,codeTimeout:void 0,codeTimeoutStep:1,codeExpirationMsg:"",otp:"",otpErrorMsgs:{title:"",text:""},checkingOTP:!1,otpVerified:!1,otpControl:null,formControl:null,resending:!1}),O=h(()=>e.myGivenName&&e.myFamilyName&&e.myEmail);U(()=>e.codeTimeout,async()=>{if(p.debug(p.context(),"codeTimeout changed to ",e.codeTimeout),e.codeTimeout!==void 0)if(e.codeTimeout<=0)p.debug(p.context(),"codeTimeout expired"),e.codeExpirationMsg="That code has expired.",e.codeTimeout=-1;else{if(e.codeTimeout>59){const s=Math.round(e.codeTimeout/60);e.codeExpirationMsg=`Your code will expire in ${s} minute${s>1?"s":""}.`,e.codeTimeoutStep=30}else e.codeExpirationMsg=`Your code will expire in ${e.codeTimeout} seconds.`,e.codeTimeoutStep=1;setTimeout(()=>{e.codeTimeout&&(e.codeTimeout-=e.codeTimeoutStep)},e.codeTimeoutStep*1e3)}},{immediate:!0}),U(()=>e.otp,()=>{e.otp=e.otp.toUpperCase()});async function $(){var s,l,_,i,C;p.debug(p.context(),"otp changed to ",e.otp);try{e.checkingOTP=!0,(s=e.otpControl)==null||s.blur();const{response:v}=await _e("/api/person/me/verify",{body:{email:(l=r==null?void 0:r.value)!=null&&l.email?null:e.myEmail,code:e.otp}});v.status==200||v.status==204?((_=e.formControl)==null||_.validate(),e.otpVerified=!0):(e.otpErrorMsgs={title:"Invalid code",text:""},(i=e.otpControl)==null||i.reset(),(C=e.otpControl)==null||C.focus())}finally{e.checkingOTP=!1}}function G(){e.movingToOtherStep=!0,Ce("/api/person/me",{body:{given_name:e.myGivenName||void 0,family_name:e.myFamilyName||void 0,birth_date:e.myBirthDate?e.myBirthDate.toISOString().substr(0,10):void 0,phone:e.myPhone||void 0}}).then(()=>{p.debug(p.context(),"going to verify"),Y.push({name:"authorized"})}).catch(s=>p.error(p.context(),s)).finally(()=>{e.movingToOtherStep=!1})}async function c(){var s;p.debug(p.context(),"resend");try{e.resending=!0,await Te((s=r==null?void 0:r.value)!=null&&s.email?void 0:e.myEmail)?(e.sentCodeCount++,e.codeTimeout=Ye):e.otpErrorMsgs={title:"Error",text:"Failed to send email"}}finally{e.resending=!1}}return(s,l)=>(P(),D(J,{class:"v-col-sm-9 v-col-lg-6 v-col-xl-4 pa-0 mt-4"},{default:n(()=>{var _;return[t(I,null,ge({title:n(()=>[T("About you")]),subtitle:n(()=>{var i;return[T(q((i=m(r))==null?void 0:i.email),1)]}),default:n(()=>[t(Ne,{ref:i=>{e.formControl=i},modelValue:e.formOk,"onUpdate:modelValue":l[9]||(l[9]=i=>e.formOk=i)},{default:n(()=>[t(J,null,{default:n(()=>[t(B,null,{default:n(()=>[t(k,null,{default:n(()=>[t(K,{type:"text",label:"Your first name",id:"myGivenName",modelValue:e.myGivenName,"onUpdate:modelValue":l[0]||(l[0]=i=>e.myGivenName=i),rules:[m(E).required,m(E).name],required:"",class:"required"},null,8,["modelValue","rules"])]),_:1}),t(k,null,{default:n(()=>[t(K,{type:"text",label:"Your last name",id:"myFamilyName",modelValue:e.myFamilyName,"onUpdate:modelValue":l[1]||(l[1]=i=>e.myFamilyName=i),rules:[m(E).required,m(E).name],required:"",class:"required"},null,8,["modelValue","rules"])]),_:1})]),_:1}),t(B,{"no-gutters":""},{default:n(()=>[t(k,null,{default:n(()=>[t(ke,{type:"tel",id:"myPhone",label:"Your phone number",modelValue:e.myPhone,"onUpdate:modelValue":l[2]||(l[2]=i=>e.myPhone=i),help:"Your phone number enables us to enhance our communication. We don't share your phone number with anyone.",rules:[m(E).phoneOrBlank]},null,8,["modelValue","rules"])]),_:1})]),_:1}),t(B,{"no-gutters":""},{default:n(()=>[t(k,null,{default:n(()=>[t(Ee,{label:"Your birth date","min-date":-100*365,"max-date":0,id:"myBirthDate",help:"Your date of birth enables us to enhance our communication. We don't share your date of birth.",date:e.myBirthDate,"onUpdate:date":l[3]||(l[3]=i=>e.myBirthDate=i),required:"",class:"required"},null,8,["date"])]),_:1})]),_:1}),t(B,{"no-gutters":""},{default:n(()=>[t(k,null,{default:n(()=>{var i;return[(i=m(r))!=null&&i.email?he("",!0):(P(),D(K,{key:0,label:"Your email",id:"myEmail",modelValue:e.myEmail,"onUpdate:modelValue":l[4]||(l[4]=C=>e.myEmail=C),rules:[m(E).required,m(E).email]},null,8,["modelValue","rules"])),e.sentCodeCount===0?(P(),D(I,{key:1,variant:"tonal",density:"compact"},{default:n(()=>[t(z,{class:"text-center"},{default:n(()=>[t(j,{icon:"mdi-alert-circle-outline",size:"large"}),T("   Your email is not confirmed yet     "),t(Ve,{disabled:!O.value,class:"mt-4",elevation:"3",variant:"tonal",block:"",onClick:c,loading:e.resending},{default:n(()=>[T("Send email confirmation code")]),_:1},8,["disabled","loading"])]),_:1})]),_:1})):V.value?(P(),D(I,{key:3,variant:"tonal"},{default:n(()=>[t(z,null,{default:n(()=>[t(B,null,{default:n(()=>[t(k,{cols:"auto",class:"align-self-center"},{default:n(()=>[t(j,{icon:"mdi-email-seal",size:"xx-large"})]),_:1}),t(k,{class:"text-left"},{default:n(()=>[S("span",null,q(e.myEmail)+" is confirmed",1),Ue]),_:1}),t(k,{cols:"auto",class:"align-self-center"},{default:n(()=>[t(Se,{disabled:!e.formOk||!V.value,onClick:G,loading:e.movingToOtherStep},{default:n(()=>[T("Continue")]),_:1},8,["disabled","loading"])]),_:1})]),_:1})]),_:1})]),_:1})):(P(),D(I,{key:2,disabled:!O.value,variant:"tonal",density:"compact"},{default:n(()=>[t(z,{class:"text-center"},{default:n(()=>{var C;return[t(j,{icon:"mdi-email",size:"large"}),T("   Check your email    "),Ae,S("div",qe," Enter the 6-letter code we sent to "+q((C=m(r))==null?void 0:C.email)+". ",1),t(m(Me),{ref:v=>{e.otpControl=v},autofocus:"",modelValue:e.otp,"onUpdate:modelValue":l[5]||(l[5]=v=>e.otp=v),onFinish:l[6]||(l[6]=v=>$()),loading:e.checkingOTP,type:"text",placeholder:"-"},null,8,["modelValue","loading"]),t(Fe,{"error-title":e.otpErrorMsgs.title,"onUpdate:errorTitle":l[7]||(l[7]=v=>e.otpErrorMsgs.title=v),"error-msg":e.otpErrorMsgs.text,"onUpdate:errorMsg":l[8]||(l[8]=v=>e.otpErrorMsgs.text=v)},null,8,["error-title","error-msg"]),S("div",Ie,[T(q(e.codeExpirationMsg)+" If you didn't receive it, please click ",1),S("a",{href:"#",onClick:xe(c,["prevent"])},"here"),T(" to send a new one. ")])]}),_:1})]),_:1},8,["disabled"]))]}),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:2},[(_=m(r))!=null&&_.picture?{name:"prepend",fn:n(()=>{var i;return[t(be,{picture:(i=m(r))==null?void 0:i.picture,firstName:e.myGivenName,lastName:e.myFamilyName,badge:m(y).invitationCount>0?m(y).invitationCount:void 0},null,8,["picture","firstName","lastName","badge"])]}),key:"0"}:void 0]),1024)]}),_:1}))}});export{We as default};
