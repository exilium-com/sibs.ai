import{d as j,b as a,c as l,w as d,U as f,V as L,X as m,e as p,g as P,S as U,f as x,P as F,h as V,W as H,T as v,b7 as O,R as K,q,b8 as W,a9 as X,b9 as G,ba as J,bb as Y,aW as Z,ab as Q,t as ee,aX as te,ap as ae,ah as z,bc as se,bd as ne,be as ie,aj as oe,as as re,ad as C,bf as ce,A as le,aB as de,J as D,H as ue,z as N,a as me,bg as he,$ as pe,a3 as t,Y as w,Z as E,bh as ye,a2 as ge,a0 as fe,a1 as ke,l as o,bi as ve,bj as _e,C as be,K as Ce,n as Ie}from"./main-DvUrgrR9.js";import{R as Me}from"./index-yXek15Gy.js";import{V as $,R as we}from"./VSkeletonLoader-RjqT2iso.js";import{V as xe}from"./VTextField-Cu_6rxR4.js";const Ve={key:0,class:"py-1 pe-1"},Re={class:"py-0 py-md-1",style:{"min-width":"30%"}},Te=x("i",{class:"fa-solid fa-ellipsis fa-beat-fade fa-lg"},null,-1),Ae={class:"small"},Se={class:"d-flex justify-space-between px-4 align-baseline"},Ne={key:1},Be={key:1,class:"py-1 ps-1"},B=j({__name:"chat-message",props:{skeleton:{type:Boolean},message:{},time:{},isMine:{},rating:{},comment:{},messageIndex:{}},setup(n){const _=n;if(isNaN(_.messageIndex))throw new Error("Message requires a numeric key");return(e,u)=>e.skeleton?(a(),l(L,{key:0},{default:d(()=>[e.isMine?(a(),l($,{key:0,type:"avatar, paragraph",class:"flex-row-reverse"})):f("",!0),e.isMine?f("",!0):(a(),l($,{key:1,type:"avatar, sentences"}))]),_:1})):(a(),m("div",{key:1,class:O(["d-flex",{"justify-end":e.isMine,"justify-start":!e.isMine}])},[e.isMine?(a(),m("div",Ve,[p(U,{color:"primary"},{default:d(()=>[p(P,{icon:"mdi-account"})]),_:1})])):f("",!0),x("div",Re,[p(K,{class:O(["mb-4",{"bg-primary-surface":e.isMine,"bg-secondary-surface":!e.isMine}])},{default:d(()=>[e.message==="…"&&!e.isMine?(a(),l(F,{key:0},{default:d(()=>[Te]),_:1})):(a(),l(F,{key:1,class:"pa-2 px-4"},{default:d(()=>[V(H(e.message),1)]),_:1})),x("div",Ae,[x("div",Se,[e.isMine?(a(),m("span",Ne)):(a(),l(we,{key:0,initialRating:e.rating,initialComment:e.comment,messageIndex:_.messageIndex},null,8,["initialRating","initialComment","messageIndex"])),e.time?(a(),l(v(Me),{key:2,class:"text-grey small",time:new Date(e.time),locale:null},null,8,["time"])):f("",!0)])])]),_:1},8,["class"])]),e.isMine?f("",!0):(a(),m("div",Be,[p(U,{color:"secondary"},{default:d(()=>[p(P,{icon:"mdi-robot"})]),_:1})]))],2))}}),Pe=q({app:Boolean,color:String,height:{type:[Number,String],default:"auto"},...W(),...X(),...G(),...J(),...Y(),...Z({tag:"footer"}),...Q()},"VFooter"),Ue=ee()({name:"VFooter",props:Pe(),setup(n,_){let{slots:e}=_;const{themeClasses:u}=te(n),{backgroundColorClasses:c,backgroundColorStyles:R}=ae(z(n,"color")),{borderClasses:T}=se(n),{elevationClasses:A}=ne(n),{roundedClasses:I}=ie(n),k=oe(32),{resizeRef:M}=re(y=>{y.length&&(k.value=y[0].target.clientHeight)}),b=C(()=>n.height==="auto"?k.value:parseInt(n.height,10)),{layoutItemStyles:r,layoutIsReady:i}=ce({id:n.name,order:C(()=>parseInt(n.order,10)),position:C(()=>"bottom"),layoutSize:b,elementSize:C(()=>n.height==="auto"?void 0:b.value),active:C(()=>n.app),absolute:z(n,"absolute")});return le(()=>p(n.tag,{ref:M,class:["v-footer",u.value,c.value,T.value,A.value,I.value,n.class],style:[R.value,n.app?r.value:{height:de(n.height)},n.style]},e)),n.app?i:{}}}),Fe={key:0,class:"alert alert-primary",role:"alert"},Oe={key:0,class:"py-2 px-2 px-md-3"},ze={key:1,class:"py-2 px-2 px-md-3"},De=j({__name:"chat-thread",props:{chatId:{},readOnly:{type:Boolean}},emits:["summaryNeedsUpdate"],setup(n,{emit:_}){const e=n,u=D(),c=ue({inputControl:null,typedMessage:"",pendingResponse:!1,invalidChatId:!1});N(()=>[u.currentAccount,e.chatId],async(r,i)=>{u.currentAccount&&(o.debug(o.context(),"chatId changed",r,i),await ve(u.currentAccount.id,e.chatId)&&t.chat?(u.chatId=e.chatId,t.chat.messages.length==0&&M(),await k(),I()):c.invalidChatId=!0)},{immediate:!0}),N(()=>e.readOnly,async(r,i)=>{o.debug(o.context(),"readonly changed =",r,i)},{immediate:!0});const R=me();N(()=>u.currentAccount,(r,i)=>{o.debug(o.context(),"currentAccount changed",r,i),u.currentAccount&&!u.isCurrentAccountMine()&&u.currentAccount.role=="admin"&&R.push({name:"chats"})},{immediate:!0});const T=_;let A=[{key:0,isMine:!1},{key:1,isMine:!0},{key:2,isMine:!1},{key:3,isMine:!0},{key:4,isMine:!1},{key:5,isMine:!0},{key:6,isMine:!1},{key:7,isMine:!0},{key:8,isMine:!1}];function I(){t.chat&&t.chat._id&&_e(t.chat)&&(o.debug(o.context(),"emitting summary needs update, chatId = ",t.chat._id,"chat =",t.chat),T("summaryNeedsUpdate"),t.dirtyChatsMetadata.add(t.chat._id))}async function k(){await be(),window.scrollTo(0,document.body.scrollHeight)}async function M(r){var h;if(!t.chat)return;o.debug(o.context(),e.chatId,{userMessage:r});const i=D();if(!i.currentAccount){o.error(o.context(),"no current account");return}r&&(t.chat.messages.push({content:r,timestamp:new Date().toISOString(),type:"User",key:t.chat.messages.length}),c.typedMessage=""),c.pendingResponse=!0;let y={content:"…",timestamp:"",type:"AI",key:t.chat.messages.length};t.chat.messages.push(y),await k();const S=r?"/api/chat/{account_id}/{chat_id}":t.chat.messages.length>1?"/api/chat/{account_id}/{chat_id}/ping":"/api/chat/{account_id}/{chat_id}/initial",{data:s,error:g}=await Ce(S,{params:{path:{account_id:i.currentAccount.id,chat_id:e.chatId}},body:{content:r??""}});g&&o.error(o.context(),g),c.pendingResponse=!1,s&&(t.chat.messages[y.key].timestamp=new Date(s.message.timestamp).toISOString(),t.chat.messages[y.key].content=s.message.content,t.chat={_id:t.chat._id,...s.metadata,messages:t.chat.messages}),await k(),(h=c.inputControl)==null||h.focus(),I()}async function b(){var r,i;if(o.debug(o.context(),"entering"),((r=c.inputControl)==null?void 0:r.value)===""){o.debug(o.context(),"sendMessage empty, ignoring.");return}M((i=c.inputControl)==null?void 0:i.value)}return(r,i)=>{const y=he("router-link"),S=pe("focus");return a(),m(w,null,[c.invalidChatId?(a(),m("div",Fe,[V(" This chat does not exist, maybe you should look in "),p(y,{to:"/chats"},{default:d(()=>[V("all chats")]),_:1}),V(". ")])):f("",!0),p(ge,null,{default:d(()=>[v(t).chat?(a(),m("div",Oe,[v(t).chat?(a(),l(ye,{key:0,name:"grow"},{default:d(()=>[(a(!0),m(w,null,E(v(t).chat.messages,s=>{var g,h;return a(),m(w,null,[s.type==="AI"?(a(),l(B,{message:s.content,time:s.timestamp,key:s.key,isMine:!1,messageIndex:s.key,rating:(g=s.rating)==null?void 0:g.rating,comment:((h=s.rating)==null?void 0:h.comment)??""},null,8,["message","time","messageIndex","rating","comment"])):(a(),l(B,{message:s.content,time:s.timestamp,key:-s.key,isMine:!0,messageIndex:s.key},null,8,["message","time","messageIndex"]))],64)}),256))]),_:1})):f("",!0)])):(a(),m("div",ze,[(a(!0),m(w,null,E(v(A),s=>(a(),l(B,{skeleton:"",key:s.key,isMine:s.isMine,messageIndex:s.key},null,8,["isMine","messageIndex"]))),128))]))]),_:1}),p(Ue,{app:"",color:"surface-darken-1"},{default:d(()=>[p(L,{class:"v-col-sm-9 v-col-lg-6 pa-0"},{default:d(()=>{var s,g;return[fe((a(),l(xe,{ref:h=>{c.inputControl=h},"hide-details":"",modelValue:c.typedMessage,"onUpdate:modelValue":i[0]||(i[0]=h=>c.typedMessage=h),density:"compact",variant:"outlined",placeholder:(s=v(t).chat)!=null&&s.closed?"Chat closed":e.readOnly?"":"Type message here",disabled:c.pendingResponse||e.readOnly||((g=v(t).chat)==null?void 0:g.closed),onClick:i[1]||(i[1]=h=>k()),onKeydown:ke(b,["enter"])},{"append-inner":d(()=>[c.typedMessage.length>0?(a(),l(P,{key:0,icon:"mdi-send-variant",color:"primary",onClick:b})):f("",!0)]),_:1},8,["modelValue","placeholder","disabled"])),[[S]])]}),_:1})]),_:1})],64)}}}),He=Ie(De,[["__scopeId","data-v-60ac8c33"]]);export{He as C};
