import{R as G}from"./index-CluUaWoL.js";import{d as S,l as F,K as A,r as u,b as m,c as p,w as o,e as l,M as O,g as b,z as w,x as h,f as z,o as ee,A as P,B as j,F as V,y as C,L as R,m as q,n as L,Z as x,af as T,v as ne,X as te,k as ie}from"./main-CuD3QBrw.js";import{r as N}from"./form-validation-Bhn6uNEO.js";import{_ as ae,a as oe}from"./primary-button.vue_vue_type_script_setup_true_lang-DVmiJhKU.js";const re=z("br",null,null,-1),le=S({__name:"my-invite-card",props:{inviter:{},accountUser:{},inviteDate:{},accept:{type:Boolean}},emits:["update:accept"],setup(I){const n=I,e=F({accountPronoun:A(()=>n.accountUser._id==n.inviter._id?"their":n.accountUser.given_name+"'s"),fullName:A(()=>n.inviter.given_name+(n.inviter.family_name?" "+n.inviter.family_name:""))});return console.log("my-invite-card: props=",n),(c,v)=>{const y=u("v-card-text"),g=u("v-icon"),i=u("v-btn"),d=u("v-spacer"),a=u("v-card-actions"),f=u("v-card"),_=u("v-card-subtitle"),k=u("v-list-item"),U=u("v-expand-transition");return m(),p(U,null,{default:o(()=>[c.accept==null?(m(),p(f,{key:0,title:e.fullName,variant:"tonal"},{prepend:o(()=>[l(O,{picture:n.inviter.avatar??void 0,firstName:n.inviter.given_name,lastName:n.inviter.family_name??""},null,8,["picture","firstName","lastName"])]),default:o(()=>[l(y,null,{default:o(()=>[b(w(c.inviter.given_name)+" wants to share "+w(e.accountPronoun)+" sibs data with you ",1),re,l(h(G),{class:"text-grey small",time:c.inviteDate,locale:null},null,8,["time"])]),_:1}),l(a,{class:"mx-4 mb-2"},{default:o(()=>[l(i,{variant:"tonal",color:"success",onClick:v[0]||(v[0]=E=>c.$emit("update:accept",!0))},{default:o(()=>[l(g,{icon:"mdi-check-bold"}),b(" Accept ")]),_:1}),l(d),l(i,{variant:"tonal",color:"secondary",onClick:v[1]||(v[1]=E=>c.$emit("update:accept",!1))},{default:o(()=>[l(g,{icon:"mdi-close-thick"}),b(" Reject ")]),_:1})]),_:1})]),_:1},8,["title"])):(m(),p(f,{key:1,variant:"flat",density:"compact"},{default:o(()=>[l(k,{color:"secondary-surface"},{prepend:o(()=>[l(O,{picture:n.inviter.avatar??void 0,firstName:n.inviter.given_name,lastName:n.inviter.family_name??"",badgeColor:"transparent","offset-y":"33"},{badge:o(()=>[c.accept?(m(),p(g,{key:0,icon:"mdi-check-bold",color:"success"})):(m(),p(g,{key:1,icon:"mdi-close-thick",color:"error"}))]),_:1},8,["picture","firstName","lastName"])]),append:o(()=>[l(i,{size:"sm",variant:"plain",icon:"mdi-arrow-u-left-top",onClick:v[2]||(v[2]=E=>c.$emit("update:accept",void 0))})]),default:o(()=>[l(_,null,{default:o(()=>[b(" You will "+w(c.accept==!0?"accept "+c.inviter.given_name:"reject "+c.inviter.given_name)+"'s invitation. ",1)]),_:1})]),_:1})]),_:1}))]),_:1})}}}),_e=S({__name:"my-invite-list",setup(I,{expose:n}){const e=F({pendingInvites:[],submitting:!1,loading:!1}),c=A(()=>e.pendingInvites?e.pendingInvites.filter(a=>a.accept==!0).length:0),v=A(()=>e.pendingInvites?e.pendingInvites.filter(a=>a.accept==!1).length:0),y=A(()=>e.pendingInvites.length),g=A(()=>{const a=c.value>1?`Accept ${c.value} invitations`:c.value>0?"Accept 1 invitation":"",f=v.value>1?`Reject ${v.value} invitations`:v.value>0?"Reject 1 invitation":"",_=c.value>0&&v.value>0?", ":"";return a+_+f});n({invitationsCount:y});async function i(){e.loading=!0;try{let a=await R("/api/person/me/invites",{});if(console.log("my-invites-list: getInvites returns",a),!a.data||a.error)throw new Error(a.error);e.pendingInvites=a.data;const f=q();f.invitationCount=e.pendingInvites.length??0,console.log("my-invites-list: getInvites invitationCount=",f.invitationCount)}catch(a){console.error("my-invites-list: getInvites error",a)}finally{e.loading=!1}}ee(async()=>{await i()});async function d(){let a=[],f=[];try{e.submitting=!0,e.pendingInvites.map(k=>{k.accept===!0?a.push(k.account_id):k.accept===!1&&f.push(k.account_id)});const{error:_}=await L("/api/person/me/invites",{body:{accept_invites:a,reject_invites:f}});if(_){console.log(_);return}await i()}finally{e.submitting=!1}}return(a,f)=>{const _=u("v-card-text"),k=u("v-btn"),U=u("v-card-actions"),E=u("v-card");return e.pendingInvites.length>0?(m(),p(E,{key:0,title:"Invitations You Received",loading:e.loading},{default:o(()=>[(m(!0),P(V,null,j(e.pendingInvites,r=>(m(),p(_,{key:r.account_id},{default:o(()=>[l(le,{accept:r.accept,"onUpdate:accept":t=>r.accept=t,inviter:r.inviter,"account-user":r.account_user,"invite-date":new Date(r.invite_date)},null,8,["accept","onUpdate:accept","inviter","account-user","invite-date"])]),_:2},1024))),128)),g.value?(m(),p(U,{key:0},{default:o(()=>[l(k,{block:"",color:"secondary",variant:"elevated",onClick:d,loading:e.submitting},{default:o(()=>[b(w(g.value),1)]),_:1},8,["loading"])]),_:1})):C("",!0)]),_:1},8,["loading"])):C("",!0)}}}),se={key:0},ue={key:1,class:"text-grey small"},D=S({__name:"account-manager-item",props:{manager:{},pending:{type:Boolean},date:{},revoke:{type:Boolean},currentAccount:{}},emits:["update:revoke"],setup(I){const n=I;function e(i){return T(n.currentAccount.value)?i?"your":"you":n.currentAccount.value.user.given_name+(i?"'s":"")}function c(i){var a;return((a=q().person)==null?void 0:a._id)==i._id||n.currentAccount.value.user._id==i._id}function v(i){return i.given_name+(i.family_name?" "+i.family_name:"")}function y(i,d){return d?i?"Your":"You":i?"your":"you"}function g(i,d,a){var _;return((_=q().person)==null?void 0:_._id)==i._id?y(d,a):v(i)+(d?"'s":"")}return(i,d)=>{const a=u("v-icon"),f=u("v-list-item-title"),_=u("v-list-item-subtitle"),k=u("v-btn"),U=u("v-list-item");return m(),p(U,null,x({prepend:o(()=>[l(O,{picture:i.manager.avatar??void 0,firstName:i.manager.given_name,lastName:i.manager.family_name??"",badgeColor:"transparent","offset-y":"30"},x({_:2},[n.revoke?{name:"badge",fn:o(()=>[l(a,{icon:"mdi-close-thick",color:"error"})]),key:"0"}:void 0]),1032,["picture","firstName","lastName"])]),default:o(()=>[i.revoke?C("",!0):(m(),p(f,{key:0},{default:o(()=>[b(w(g(i.manager,!1,!0)),1)]),_:1})),c(i.manager)?C("",!0):(m(),p(_,{key:1},{default:o(()=>[i.revoke?(m(),P("span",se," You will "+w(i.pending?"not share":"stop sharing")+" "+w(e(!0))+" sibs data with "+w(g(i.manager,!1,!1)),1)):i.date?(m(),P("span",ue,[b(" Invited "),l(h(G),{time:new Date(i.date),locale:null},null,8,["time"])])):C("",!0)]),_:1}))]),_:2},[c(i.manager)?void 0:{name:"append",fn:o(()=>[i.revoke?(m(),p(k,{key:0,size:"sm",variant:"plain",icon:"mdi-arrow-u-left-top",onClick:d[0]||(d[0]=E=>i.$emit("update:revoke",!1))})):(m(),p(k,{key:1,onClick:d[1]||(d[1]=E=>i.$emit("update:revoke",!0)),color:"success",variant:"tonal",class:"px-2"},{default:o(()=>[l(a,{icon:"mdi-close-thick"}),b(" Revoke ")]),_:1}))]),key:"0"}]),1024)}}}),ce=S({__name:"invitation-form",props:{givenName:{},familyName:{},email:{},emailConfirmation:{},phone:{}},emits:["update:givenName","update:familyName","update:email","update:emailConfirmation","update:phone","update:formOk"],setup(I){const n=I,e=F({formOk:!1});return(c,v)=>{const y=u("v-text-field"),g=u("v-col"),i=u("v-row"),d=u("v-form");return m(),p(d,{class:"pa-1",value:e.formOk,"onUpdate:modelValue":v[5]||(v[5]=a=>c.$emit("update:formOk",a))},{default:o(()=>[l(i,null,{default:o(()=>[l(g,null,{default:o(()=>[l(y,{type:"text",label:"Their first name",id:"givenName",value:n.givenName,"onUpdate:modelValue":v[0]||(v[0]=a=>c.$emit("update:givenName",a)),rules:[h(N).required,h(N).name],required:""},null,8,["value","rules"])]),_:1}),l(g,null,{default:o(()=>[l(y,{type:"text",label:"Their last name",id:"familyName",value:n.familyName,"onUpdate:modelValue":v[1]||(v[1]=a=>c.$emit("update:familyName",a)),rules:[h(N).required,h(N).name],required:""},null,8,["value","rules"])]),_:1})]),_:1}),l(y,{type:"email",label:"Their e-mail",id:"email",value:n.email,"onUpdate:modelValue":v[2]||(v[2]=a=>c.$emit("update:email",a)),rules:[h(N).required,h(N).email],required:""},null,8,["value","rules"]),c.email?(m(),p(y,{key:0,type:"email",label:"Confirm  e-mail",id:"emailConfirmation",value:n.emailConfirmation,"onUpdate:modelValue":v[3]||(v[3]=a=>c.$emit("update:emailConfirmation",a)),rules:[h(N).required,h(N).email,h(N).sameAs(c.email,"e-mails")],required:""},null,8,["value","rules"])):C("",!0),l(y,{type:"tel",label:"Their phone",id:"phone",value:n.phone,"onUpdate:modelValue":v[4]||(v[4]=a=>c.$emit("update:phone",a)),rules:[h(N).phoneOrBlank]},null,8,["value","rules"])]),_:1},8,["value"])}}}),ve=S({__name:"account-manager-list",props:{currentAccount:{}},setup(I){const n=I,e=F({expand:!1,submitting:!1,inviting:!1,loading:!1,currentAccountAdmins:[],currentAccountInvites:[],inviteeGivenName:"",inviteeFamilyName:"",inviteeEmail:"",inviteeEmailConfirmation:"",inviteePhone:"",inviteeFormOk:!1,invitePanel:[],inviteError:!1,inviteErrorMsg:"",inviteErrorTitleMsg:""}),c=A(()=>e.currentAccountInvites?e.currentAccountInvites.filter(r=>r.revoke&&r.pending).length:0),v=A(()=>e.currentAccountAdmins?e.currentAccountAdmins.filter(r=>r.revoke&&!r.pending).length:0),y=A(()=>{if(e.currentAccountAdmins==null)return;let r=!1;for(let t of e.currentAccountAdmins)if(t.person._id!=n.currentAccount.value.user._id){r=!0;break}return r}),g=A(()=>y.value?T(n.currentAccount.value)?"You are sharing your sibs data with:":`${a.value} is sharing their sibs data with:`:T(n.currentAccount.value)?"Share your sibs data":`${a.value} is not sharing their sibs data with anyone`),i=A(()=>!y.value&&T(n.currentAccount.value)?"You can invite other people to share your data. They will be able to see your data and help you whenever needed.":""),d=A(()=>{const r=c.value+v.value;return r>1?`Stop sharing with ${r} people`:r>0?`Stop sharing with ${r} person`:""}),a=A(()=>n.currentAccount.value.user.given_name+(n.currentAccount.value.user.family_name?" "+n.currentAccount.value.user.family_name:""));function f(r){return T(n.currentAccount.value)?r?"your":"you":n.currentAccount.value.user.given_name+(r?"'s":"")}ne(n.currentAccount,async()=>{e.currentAccountAdmins=void 0,e.currentAccountInvites=void 0,e.loading=!0;try{await _(),await k()}finally{e.loading=!1}},{immediate:!0});async function _(){const{data:r,error:t}=await R("/api/account/{account_id}/admins",{params:{path:{account_id:n.currentAccount.value.id}}});t&&console.error(t),e.currentAccountAdmins=r?r.map($=>({person:$})):[]}async function k(){const{data:r,error:t}=await R("/api/account/{account_id}/invites",{params:{path:{account_id:n.currentAccount.value.id}}});t&&console.error(t);let $=r?r.filter(M=>M.state==="pending"):[];e.currentAccountInvites=$.map(M=>({person:M.invitee,invite_date:M.invite_date,pending:!0}))}async function U(){let r=[];for(let t of e.currentAccountAdmins??[])t.revoke&&r.push(t.person._id);for(let t of e.currentAccountInvites??[])t.revoke&&r.push(t.person._id);try{if(e.submitting=!0,r.length>0){const{error:t}=await te("/api/account/{account_id}/invites",{params:{path:{account_id:n.currentAccount.value.id}},body:r});t&&console.error(t),await _(),await k()}}finally{e.submitting=!1}}async function E(){var r;try{e.inviting=!0;const t=await L("/api/account/{account_id}/invite",{params:{path:{account_id:n.currentAccount.value.id}},body:{given_name:e.inviteeGivenName,family_name:e.inviteeFamilyName||void 0,email:e.inviteeEmail,phone:e.inviteePhone||void 0}});if(t.error){const $={403:"You can't invite other parties to this account",405:"Maximum number of invites reached for this account",409:"This person is already invited to this account"};e.inviteError=!0,e.inviteErrorMsg=$[t.response.status]??"Error inviting this person",e.inviteErrorTitleMsg="Problem inviting "+e.inviteeGivenName,console.log("invitePerson: inviteError",e.inviteErrorMsg,e.inviteErrorTitleMsg)}else{let $={person:t.data.invitee,invite_date:t.data.invite_date,pending:!0};(r=e.currentAccountInvites)==null||r.push($),e.inviteeGivenName="",e.inviteeFamilyName="",e.inviteeEmail="",e.inviteeEmailConfirmation="",e.inviteePhone="",e.invitePanel=[],e.inviteError=!1,e.inviteErrorMsg="",e.inviteErrorTitleMsg=""}}finally{e.inviting=!1}}return(r,t)=>{const $=u("v-card-title"),M=u("v-list-subheader"),K=u("v-list"),Y=u("v-card-text"),X=u("v-btn"),Z=u("v-card-actions"),H=u("v-expansion-panel-text"),J=u("v-expansion-panel"),Q=u("v-expansion-panels"),W=u("v-card");return n.currentAccount.value.user._id?(m(),p(W,{key:0,color:"surface",loading:e.loading},{default:o(()=>[l($,{class:"text-wrap"},{default:o(()=>[b(w(g.value),1)]),_:1}),l(Y,null,{default:o(()=>[b(w(i.value)+" ",1),l(K,null,{default:o(()=>[(m(!0),P(V,null,j(e.currentAccountAdmins,s=>(m(),P(V,null,[s.person._id!=n.currentAccount.value.user._id?(m(),p(D,{key:s.person._id??s.person.email,revoke:s.revoke,"onUpdate:revoke":B=>s.revoke=B,manager:s.person,"current-account":n.currentAccount,lines:"two"},null,8,["revoke","onUpdate:revoke","manager","current-account"])):C("",!0)],64))),256)),e.currentAccountInvites&&e.currentAccountInvites.length>0?(m(),p(M,{key:0},{default:o(()=>[b(" Pending")]),_:1})):C("",!0),(m(!0),P(V,null,j(e.currentAccountInvites,s=>(m(),p(D,{key:s.person._id??s.person.email,variant:"tonal",lines:"two",revoke:s.revoke,"onUpdate:revoke":B=>s.revoke=B,manager:s.person,"current-account":n.currentAccount,pending:!0,date:new Date(s.invite_date)},null,8,["revoke","onUpdate:revoke","manager","current-account","date"]))),128))]),_:1})]),_:1}),d.value?(m(),p(Z,{key:0},{default:o(()=>[l(X,{block:"",color:"secondary",variant:"elevated",onClick:U,loading:e.submitting},{default:o(()=>[b(w(d.value),1)]),_:1},8,["loading"])]),_:1})):C("",!0),l(Y,null,{default:o(()=>[l(Q,{multiple:"",modelValue:e.invitePanel,"onUpdate:modelValue":t[9]||(t[9]=s=>e.invitePanel=s)},{default:o(()=>[l(J,{"bg-color":"info-surface",color:"info-surface",value:"invite",title:`Share ${f(!0)} sibs data with another person`},{default:o(()=>[l(H,{id:"expansionPanelText",color:"info-surface"},{default:o(()=>[l(ce,{"given-name":e.inviteeGivenName,"onUpdate:givenName":t[0]||(t[0]=s=>e.inviteeGivenName=s),"family-name":e.inviteeFamilyName,"onUpdate:familyName":t[1]||(t[1]=s=>e.inviteeFamilyName=s),email:e.inviteeEmail,"onUpdate:email":t[2]||(t[2]=s=>e.inviteeEmail=s),"email-confirmation":e.inviteeEmailConfirmation,"onUpdate:emailConfirmation":t[3]||(t[3]=s=>e.inviteeEmailConfirmation=s),phone:e.inviteePhone,"onUpdate:phone":t[4]||(t[4]=s=>e.inviteePhone=s),"onUpdate:formOk":t[5]||(t[5]=s=>e.inviteeFormOk=s)},null,8,["given-name","family-name","email","email-confirmation","phone"]),z("div",null,[l(ae,{"error-msg":e.inviteErrorMsg,"onUpdate:errorMsg":t[6]||(t[6]=s=>e.inviteErrorMsg=s),"error-title":e.inviteErrorTitleMsg,"onUpdate:errorTitle":t[7]||(t[7]=s=>e.inviteErrorTitleMsg=s)},null,8,["error-msg","error-title"]),l(oe,{color:"info",block:"",onClick:t[8]||(t[8]=s=>E()),disabled:!e.inviteeFormOk,loading:e.inviting,enabledColor:"info"},{default:o(()=>[b("Invite")]),_:1},8,["disabled","loading"])])]),_:1})]),_:1},8,["title"])]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["loading"])):C("",!0)}}}),ge=ie(ve,[["__scopeId","data-v-80dc5bdf"]]);export{ge as A,_e as _};
