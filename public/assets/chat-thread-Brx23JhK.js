var K=Object.defineProperty;var L=(h,r,e)=>r in h?K(h,r,{enumerable:!0,configurable:!0,writable:!0,value:e}):h[r]=e;var f=(h,r,e)=>(L(h,typeof r!="symbol"?r+"":r,e),e);import{d as F,r as d,b as a,c as l,w as u,z as _,B as p,e as y,f as U,g as V,A as J,y as k,S as j,n as q,m as P,l as s,T as W,x as O,a as Q,H as t,q as X,D as Y,F as S,C as z,U as Z,E as ee,G as te,V as ae,W as se,J as ne,k as ie}from"./main-_0WdI2da.js";import{R as oe}from"./index-e_AqwlmS.js";import{R as ce}from"./rating-popup-DhQNbyUp.js";const re={key:0,class:"py-1 pe-1"},le={class:"py-0 py-md-1",style:{"min-width":"30%"}},de=U("i",{class:"fa-solid fa-ellipsis fa-beat-fade fa-lg"},null,-1),ue={class:"small"},me={class:"d-flex justify-space-between px-4 align-baseline"},pe={key:1},he={key:1,class:"py-1 ps-1"},$=F({__name:"chat-message",props:{skeleton:{type:Boolean},message:{},time:{},isMine:{},rating:{},comment:{},messageIndex:{}},setup(h){const r=h;if(isNaN(r.messageIndex))throw new Error("Message requires a numeric key");return(e,m)=>{const i=d("v-skeleton-loader"),M=d("v-container"),b=d("v-icon"),x=d("v-avatar"),w=d("v-card-text"),A=d("v-card");return e.skeleton?(a(),l(M,{key:0},{default:u(()=>[e.isMine?(a(),l(i,{key:0,type:"avatar, paragraph",class:"flex-row-reverse"})):_("",!0),e.isMine?_("",!0):(a(),l(i,{key:1,type:"avatar, sentences"}))]),_:1})):(a(),p("div",{key:1,class:j(["d-flex",{"justify-end":e.isMine,"justify-start":!e.isMine}])},[e.isMine?(a(),p("div",re,[y(x,{color:"primary"},{default:u(()=>[y(b,{icon:"mdi-account"})]),_:1})])):_("",!0),U("div",le,[y(A,{class:j(["mb-4",{"bg-primary-surface":e.isMine,"bg-secondary-surface":!e.isMine}])},{default:u(()=>[e.message==="…"&&!e.isMine?(a(),l(w,{key:0},{default:u(()=>[de]),_:1})):(a(),l(w,{key:1,class:"pa-2 px-4"},{default:u(()=>[V(J(e.message),1)]),_:1})),U("div",ue,[U("div",me,[e.isMine?(a(),p("span",pe)):(a(),l(ce,{key:0,initialRating:e.rating,initialComment:e.comment,messageIndex:r.messageIndex},null,8,["initialRating","initialComment","messageIndex"])),e.time?(a(),l(k(oe),{key:2,class:"text-grey small",time:new Date(e.time),locale:null},null,8,["time"])):_("",!0)])])]),_:1},8,["class"])]),e.isMine?_("",!0):(a(),p("div",he,[y(x,{color:"secondary"},{default:u(()=>[y(b,{icon:"mdi-robot"})]),_:1})]))],2))}}});class ye{constructor(r,e,m){f(this,"timeoutId",null);f(this,"timeoutMs");f(this,"userCallback");f(this,"maxConsecutiveIdleCalls");f(this,"boundInternalCallback");f(this,"consecutiveIdleCalls",0);this.timeoutMs=r,this.userCallback=m,this.maxConsecutiveIdleCalls=e,this.boundInternalCallback=this.internalCallback.bind(this),this.reset()}internalCallback(){this.consecutiveIdleCalls++,this.timeoutId=0,this.userCallback()}reset(){this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=0,this.consecutiveIdleCalls=0),!(this.consecutiveIdleCalls>=this.maxConsecutiveIdleCalls)&&(this.timeoutId=setTimeout(this.boundInternalCallback,this.timeoutMs))}clear(){this.timeoutId&&(clearTimeout(this.timeoutId),this.timeoutId=0)}}const _e={key:0,class:"alert alert-primary",role:"alert"},ge={key:0,class:"py-2 px-2 px-md-3"},fe={key:1,class:"py-2 px-2 px-md-3"},ke=F({__name:"chat-thread",props:{chatId:{},readOnly:{type:Boolean}},emits:["summaryNeedsUpdate"],setup(h,{emit:r}){const e=h,m=q(),i=P({inputControl:null,typedMessage:"",pendingResponse:!1,invalidChatId:!1}),M=new ye(6e4,2,()=>{s.debug(s.context(),"pinging user"),B()});W(()=>{M.clear()}),O(()=>[m.currentAccount,e.chatId],async(c,o)=>{m.currentAccount&&(s.debug(s.context(),"chatId changed",c,o),await ae(m.currentAccount.id,e.chatId)&&t.chat?(m.chatId=e.chatId,t.chat.messages.length==0&&B(),await T(),A()):i.invalidChatId=!0)},{immediate:!0}),O(()=>e.readOnly,async(c,o)=>{s.debug(s.context(),"readonly changed =",c,o)},{immediate:!0});const b=Q();O(()=>m.currentAccount,(c,o)=>{s.debug(s.context(),"currentAccount changed",c,o),m.currentAccount&&!m.isCurrentAccountMine()&&m.currentAccount.role=="admin"&&b.push({name:"chats"})},{immediate:!0});const x=r;let w=[{key:0,isMine:!1},{key:1,isMine:!0},{key:2,isMine:!1},{key:3,isMine:!0},{key:4,isMine:!1},{key:5,isMine:!0},{key:6,isMine:!1},{key:7,isMine:!0},{key:8,isMine:!1}];function A(){t.chat&&t.chat._id&&se(t.chat)&&(s.debug(s.context(),"emitting summary needs update, chatId = ",t.chat._id,"chat =",t.chat),x("summaryNeedsUpdate"),t.dirtyChatsMetadata.add(t.chat._id))}async function T(){await ne(),window.scrollTo(0,document.body.scrollHeight)}async function B(c){var R;if(!t.chat)return;s.debug(s.context(),e.chatId,{userMessage:c});const o=q();if(!o.currentAccount){s.error(s.context(),"no current account");return}c&&(t.chat.messages.push({content:c,timestamp:new Date().toISOString(),type:"User",key:t.chat.messages.length}),i.typedMessage=""),i.pendingResponse=!0;let v={content:"…",timestamp:"",type:"AI",key:t.chat.messages.length};t.chat.messages.push(v),await T();const D=c?"/api/chat/{account_id}/{chat_id}":t.chat.messages.length>1?"/api/chat/{account_id}/{chat_id}/ping":"/api/chat/{account_id}/{chat_id}/initial",{data:I,error:N}=await X(D,{params:{path:{account_id:o.currentAccount.id,chat_id:e.chatId}},body:{content:c??""}});N&&s.error(s.context(),N),i.pendingResponse=!1,I&&(t.chat.messages[v.key].timestamp=new Date(I.message.timestamp).toISOString(),t.chat.messages[v.key].content=I.message.content,t.chat={_id:t.chat._id,...I.metadata,messages:t.chat.messages}),await T(),(R=i.inputControl)==null||R.focus(),A(),M.reset()}async function E(){var c,o;if(s.debug(s.context(),"entering"),((c=i.inputControl)==null?void 0:c.value)===""){s.debug(s.context(),"sendMessage empty, ignoring.");return}B((o=i.inputControl)==null?void 0:o.value)}return(c,o)=>{const v=d("router-link"),D=d("v-expand-transition"),I=d("v-icon"),N=d("v-text-field"),R=d("v-container"),G=d("v-footer"),H=Y("focus");return a(),p(S,null,[i.invalidChatId?(a(),p("div",_e,[V(" This chat does not exist, maybe you should look in "),y(v,{to:"/chats"},{default:u(()=>[V("all chats")]),_:1}),V(". ")])):_("",!0),y(D,null,{default:u(()=>[k(t).chat?(a(),p("div",ge,[k(t).chat?(a(),l(Z,{key:0,name:"grow"},{default:u(()=>[(a(!0),p(S,null,z(k(t).chat.messages,n=>{var C,g;return a(),p(S,null,[n.type==="AI"?(a(),l($,{message:n.content,time:n.timestamp,key:n.key,isMine:!1,messageIndex:n.key,rating:(C=n.rating)==null?void 0:C.rating,comment:((g=n.rating)==null?void 0:g.comment)??""},null,8,["message","time","messageIndex","rating","comment"])):(a(),l($,{message:n.content,time:n.timestamp,key:-n.key,isMine:!0,messageIndex:n.key},null,8,["message","time","messageIndex"]))],64)}),256))]),_:1})):_("",!0)])):(a(),p("div",fe,[(a(!0),p(S,null,z(k(w),n=>(a(),l($,{skeleton:"",key:n.key,isMine:n.isMine,messageIndex:n.key},null,8,["isMine","messageIndex"]))),128))]))]),_:1}),y(G,{app:"",color:"surface-darken-1"},{default:u(()=>[y(R,{class:"v-col-sm-9 v-col-lg-6 pa-0"},{default:u(()=>{var n,C;return[ee((a(),l(N,{ref:g=>{i.inputControl=g},"hide-details":"",modelValue:i.typedMessage,"onUpdate:modelValue":o[0]||(o[0]=g=>i.typedMessage=g),density:"compact",variant:"outlined",placeholder:(n=k(t).chat)!=null&&n.closed?"Chat closed":e.readOnly?"":"Type message here",disabled:i.pendingResponse||e.readOnly||((C=k(t).chat)==null?void 0:C.closed),onClick:o[1]||(o[1]=g=>T()),onKeydown:te(E,["enter"])},{"append-inner":u(()=>[i.typedMessage.length>0?(a(),l(I,{key:0,icon:"mdi-send-variant",color:"primary",onClick:E})):_("",!0)]),_:1},8,["modelValue","placeholder","disabled"])),[[H]])]}),_:1})]),_:1})],64)}}}),be=ie(ke,[["__scopeId","data-v-df6002a2"]]);export{be as C};
