import{d as q,u as z,a as I,m as A,K as W,l as K,v as D,c as g,w as t,r as u,b as h,e as o,Z as R,x as i,M as X,g as f,z as T,y as Z,f as _,ab as j,$ as H,n as J,s as L,ac as Q}from"./main-CuD3QBrw.js";import{r as v}from"./form-validation-Bhn6uNEO.js";import{_ as ee,a as oe}from"./date-field.vue_vue_type_script_setup_true_lang-DXqCERxD.js";import{_ as te,a as le}from"./primary-button.vue_vue_type_script_setup_true_lang-DVmiJhKU.js";const ne=_("br",null,null,-1),ae={class:"text-grey mt-3"},ie={class:"text-grey mt-3"},re=_("br",null,null,-1),se=15*60,fe=q({__name:"signup-profile",setup(me){var k,N,M,O,S,w;const{user:a}=z(),Y=I(),m=A(),C=W(()=>{var r,l,d;return e.otpVerified||((r=a==null?void 0:a.value)==null?void 0:r.email)&&((l=a==null?void 0:a.value)==null?void 0:l.email_verified)||((d=m.person)==null?void 0:d.validation)==="Verified"});console.log("signup-profile.vue: person = ",m.person);const e=K({movingToOtherStep:!1,formOk:!1,myGivenName:((k=m.person)==null?void 0:k.given_name)??"",myFamilyName:((N=m.person)==null?void 0:N.family_name)??"",myEmail:((M=m.person)==null?void 0:M.email)??"",myPhone:((O=m.person)==null?void 0:O.phone)??"",myBirthDate:(S=m.person)!=null&&S.birth_date?new Date((w=m.person)==null?void 0:w.birth_date):void 0,sentCodeCount:0,codeTimeout:void 0,codeTimeoutStep:1,codeExpirationMsg:"",otp:"",otpErrorMsgs:{title:"",text:""},checkingOTP:!1,otpVerified:!1,otpControl:null,formControl:null,resending:!1});D(()=>e.codeTimeout,async()=>{if(console.log("signup-profile.vue: codeTimeout changed to ",e.codeTimeout),e.codeTimeout!==void 0)if(e.codeTimeout<=0)console.log("signup-profile.vue: codeTimeout expired"),e.codeExpirationMsg="That code has expired.",e.codeTimeout=-1;else{if(e.codeTimeout>59){const r=Math.round(e.codeTimeout/60);e.codeExpirationMsg=`Your code will expire in ${r} minute${r>1?"s":""}.`,e.codeTimeoutStep=30}else e.codeExpirationMsg=`Your code will expire in ${e.codeTimeout} seconds.`,e.codeTimeoutStep=1;setTimeout(()=>{e.codeTimeout&&(e.codeTimeout-=e.codeTimeoutStep)},e.codeTimeoutStep*1e3)}},{immediate:!0}),D(()=>e.otp,()=>{e.otp=e.otp.toUpperCase()});async function $(){var r,l,d,s,p;console.log("signup-profile.vue: otp changed to ",e.otp);try{e.checkingOTP=!0,(r=e.otpControl)==null||r.blur();const{response:y}=await J("/api/person/me/verify",{body:{email:(l=a==null?void 0:a.value)!=null&&l.email?null:e.myEmail,code:e.otp}});y.status==200||y.status==204?((d=e.formControl)==null||d.validate(),e.otpVerified=!0):(e.otpErrorMsgs={title:"Invalid code",text:""},(s=e.otpControl)==null||s.reset(),(p=e.otpControl)==null||p.focus())}finally{e.checkingOTP=!1}}function P(){e.movingToOtherStep=!0,L("/api/person/me",{body:{given_name:e.myGivenName||void 0,family_name:e.myFamilyName||void 0,birth_date:e.myBirthDate?e.myBirthDate.toISOString().substr(0,10):void 0,phone:e.myPhone||void 0}}).then(()=>{console.log("signup-profile.vue: going to verify"),Y.push({name:"authorized"})}).catch(r=>console.error(r)).finally(()=>{e.movingToOtherStep=!1})}async function E(){var r;console.log("signup-profile.vue: resend");try{e.resending=!0,await Q((r=a==null?void 0:a.value)!=null&&r.email?void 0:e.myEmail)?(e.sentCodeCount++,e.codeTimeout=se):e.otpErrorMsgs={title:"Error",text:"Failed to send email"}}finally{e.resending=!1}}return(r,l)=>{const d=u("v-text-field"),s=u("v-col"),p=u("v-row"),y=u("v-icon"),F=u("v-btn"),V=u("v-card-text"),b=u("v-card"),U=u("v-container"),G=u("v-form");return h(),g(U,{class:"v-col-sm-9 v-col-lg-6 v-col-xl-4 pa-0 mt-4"},{default:t(()=>{var B;return[o(b,null,R({title:t(()=>[f("About you")]),subtitle:t(()=>{var n;return[f(T((n=i(a))==null?void 0:n.email),1)]}),default:t(()=>[o(G,{ref:n=>{e.formControl=n},modelValue:e.formOk,"onUpdate:modelValue":l[9]||(l[9]=n=>e.formOk=n)},{default:t(()=>[o(U,null,{default:t(()=>[o(p,null,{default:t(()=>[o(s,null,{default:t(()=>[o(d,{type:"text",label:"Your first name",id:"myGivenName",modelValue:e.myGivenName,"onUpdate:modelValue":l[0]||(l[0]=n=>e.myGivenName=n),rules:[i(v).required,i(v).name],required:""},null,8,["modelValue","rules"])]),_:1}),o(s,null,{default:t(()=>[o(d,{type:"text",label:"Your last name",id:"myFamilyName",modelValue:e.myFamilyName,"onUpdate:modelValue":l[1]||(l[1]=n=>e.myFamilyName=n),rules:[i(v).required,i(v).name],required:""},null,8,["modelValue","rules"])]),_:1})]),_:1}),o(p,{"no-gutters":""},{default:t(()=>[o(s,null,{default:t(()=>[o(ee,{type:"tel",id:"myPhone",label:"Your phone number",modelValue:e.myPhone,"onUpdate:modelValue":l[2]||(l[2]=n=>e.myPhone=n),help:"Your phone number enables us to enhance our communication. We don't share your phone number with anyone.",rules:[i(v).phoneOrBlank]},null,8,["modelValue","rules"])]),_:1})]),_:1}),o(p,{"no-gutters":""},{default:t(()=>[o(s,null,{default:t(()=>[o(oe,{label:"Your birth date","min-date":-100*365,"max-date":0,id:"myBirthDate",help:"Your date of birth enables us to enhance our communication. We don't share your date of birth.",date:e.myBirthDate,"onUpdate:date":l[3]||(l[3]=n=>e.myBirthDate=n)},null,8,["date"])]),_:1})]),_:1}),o(p,{"no-gutters":""},{default:t(()=>[o(s,null,{default:t(()=>{var n;return[(n=i(a))!=null&&n.email?Z("",!0):(h(),g(d,{key:0,label:"Your email",id:"myEmail",modelValue:e.myEmail,"onUpdate:modelValue":l[4]||(l[4]=x=>e.myEmail=x),rules:[i(v).required,i(v).email]},null,8,["modelValue","rules"])),e.sentCodeCount===0?(h(),g(b,{key:1,variant:"tonal",density:"compact"},{default:t(()=>[o(V,{class:"text-center"},{default:t(()=>[o(y,{icon:"mdi-alert-circle-outline",size:"large"}),f("   Your email is not confirmed yet     "),o(F,{disabled:!e.myEmail,class:"mt-4",elevation:"3",variant:"tonal",block:"",onClick:E,loading:e.resending},{default:t(()=>[f("Send email confirmation code")]),_:1},8,["disabled","loading"])]),_:1})]),_:1})):C.value?(h(),g(b,{key:3,variant:"tonal"},{default:t(()=>[o(V,null,{default:t(()=>[o(p,null,{default:t(()=>[o(s,{cols:"auto",class:"align-self-center"},{default:t(()=>[o(y,{icon:"mdi-email-seal",size:"xx-large"})]),_:1}),o(s,{class:"text-left"},{default:t(()=>[_("span",null,T(e.myEmail)+" is confirmed",1),re]),_:1}),o(s,{cols:"auto",class:"align-self-center"},{default:t(()=>[o(le,{disabled:!e.formOk||!C.value,onClick:P,loading:e.movingToOtherStep},{default:t(()=>[f("Continue")]),_:1},8,["disabled","loading"])]),_:1})]),_:1})]),_:1})]),_:1})):(h(),g(b,{key:2,disabled:!e.myEmail,variant:"tonal",density:"compact"},{default:t(()=>[o(V,{class:"text-center"},{default:t(()=>{var x;return[o(y,{icon:"mdi-email",size:"large"}),f("   Check your email    "),ne,_("div",ae," Enter the 6-letter code we sent to "+T((x=i(a))==null?void 0:x.email)+". ",1),o(i(j),{ref:c=>{e.otpControl=c},autofocus:"",modelValue:e.otp,"onUpdate:modelValue":l[5]||(l[5]=c=>e.otp=c),onFinish:l[6]||(l[6]=c=>$()),loading:e.checkingOTP,type:"text",placeholder:"-"},null,8,["modelValue","loading"]),o(te,{"error-title":e.otpErrorMsgs.title,"onUpdate:errorTitle":l[7]||(l[7]=c=>e.otpErrorMsgs.title=c),"error-msg":e.otpErrorMsgs.text,"onUpdate:errorMsg":l[8]||(l[8]=c=>e.otpErrorMsgs.text=c)},null,8,["error-title","error-msg"]),_("div",ie,[f(T(e.codeExpirationMsg)+" If you didn't receive it, please click ",1),_("a",{href:"#",onClick:H(E,["prevent"])},"here"),f(" to send a new one. ")])]}),_:1})]),_:1},8,["disabled"]))]}),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:2},[(B=i(a))!=null&&B.picture?{name:"prepend",fn:t(()=>{var n;return[o(X,{picture:(n=i(a))==null?void 0:n.picture,firstName:e.myGivenName,lastName:e.myFamilyName,badge:i(m).invitationCount>0?i(m).invitationCount:void 0},null,8,["picture","firstName","lastName","badge"])]}),key:"0"}:void 0]),1024)]}),_:1})}}});export{fe as default};
