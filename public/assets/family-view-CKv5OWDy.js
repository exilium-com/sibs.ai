import{_ as h}from"./mermaid-graph.vue_vue_type_style_index_0_lang-CXN8o6al.js";import{d as F,l as A,o as M,c as s,w as r,m as f,L as _,Q as g,r as c,b as i,e as o,g as m,z as O,y,n as b,k as S}from"./main-CuD3QBrw.js";import{C as $}from"./chat-thread-DqMBZLQO.js";import"./_commonjsHelpers-Cpj98o6Y.js";import"./index-CluUaWoL.js";import"./rating-popup-CE0OOCdk.js";const q=F({__name:"family-view",setup(B){const e=A({familyMap:void 0,familyTree:void 0,personName:void 0,activeTabId:"mindmap",familyChat:void 0,needsUpdate:!1,processingUpdate:!1,readOnly:!1});async function v(){console.log("fetchFamily");const n=f();if(console.log(`person is ${n.person}`),!n.person){console.error("no person");return}e.personName=n.person.given_name;{const{data:a,error:t}=await _("/api/person/me/family",{params:{query:{format:"mermaid_mindmap"}}});console.log(a),t||a.mermaid_mindmap==null?(e.familyMap=`mindmap
  id((**${e.personName}**<br>*self*))
  :::self level0
`,e.activeTabId="chat",t&&console.error(t)):(e.familyMap=a.mermaid_mindmap,console.log(e.familyMap))}{const{data:a,error:t}=await _("/api/person/me/family",{params:{query:{format:"mermaid_graph"}}});console.log(a),t||a.mermaid_graph==null?(e.familyTree=`graph
  id((${e.personName}<br>self))
`,t&&console.error(t)):(e.familyTree=a.mermaid_graph,console.log(e.familyTree))}}async function w(){var l;console.log("fetchFamilyChat");const n=f();if(console.log(`accountId is ${(l=n.currentAccount)==null?void 0:l.id}`),!n.currentAccount){console.error("no current account"),e.familyChat=void 0;return}const{data:a,error:t}=await _("/api/account/{account_id}/latestchat",{params:{path:{account_id:n.currentAccount.id},query:{kind:"family_tree",closed:!1}}});t?console.error(t):(a==null?e.familyChat=await g("family_tree"):e.familyChat=a._id,console.log(a),console.log(e.familyChat))}async function C(){console.log("updateFamily");const n=f();if(!n.currentAccount){console.error("no current account");return}e.readOnly=!0,e.processingUpdate=!0,console.log("summarizing chat"),b("/api/chat/{account_id}/{chat_id}/summarize",{params:{path:{account_id:n.currentAccount.id,chat_id:e.familyChat}}}).then(async a=>{if(console.log("summarize returns",a),await v(),e.activeTabId="mindmap",e.needsUpdate=!1,!n.currentAccount){console.error("no current account");return}console.log("closing chat");const{error:t}=await b("/api/chat/{account_id}/{chat_id}/close",{params:{path:{account_id:n.currentAccount.id,chat_id:e.familyChat}}});t?console.error(t):e.familyChat=await g("family_tree")}).finally(()=>{e.processingUpdate=!1,e.readOnly=!1})}M(async()=>{await v(),await w()});function T(){console.log("changeNeedsUpdate"),e.needsUpdate=!0}return(n,a)=>{const t=c("v-card-title"),l=c("v-icon"),d=c("v-tab"),U=c("v-tabs"),p=c("v-window-item"),N=c("v-window"),I=c("v-card-text"),k=c("v-card"),x=c("v-progress-circular"),V=c("v-btn"),z=c("v-container");return i(),s(z,{class:"h-100 v-col-sm-9 v-col-lg-6"},{default:r(()=>[o(k,{class:"py-2 h-100"},{default:r(()=>[e.personName?(i(),s(t,{key:0,class:"text-center"},{default:r(()=>[m(O(e.personName)+"'s Family ",1)]),_:1})):y("",!0),o(U,{modelValue:e.activeTabId,"onUpdate:modelValue":a[0]||(a[0]=u=>e.activeTabId=u),"align-tabs":"center","fixed-tabs":""},{default:r(()=>[o(d,{value:"mindmap"},{default:r(()=>[o(l,{icon:"mdi-atom",size:"large"}),m("  Relations ")]),_:1}),o(d,{value:"tree"},{default:r(()=>[o(l,{icon:"mdi-sitemap",size:"large"}),m(" Tree ")]),_:1}),o(d,{value:"chat"},{default:r(()=>[o(l,{icon:"mdi-comment-multiple",size:"large"}),m(" Chat ")]),_:1})]),_:1},8,["modelValue"]),o(I,{class:"h-100"},{default:r(()=>[o(N,{modelValue:e.activeTabId,"onUpdate:modelValue":a[1]||(a[1]=u=>e.activeTabId=u),class:"h-100"},{default:r(()=>[o(p,{value:"mindmap",class:"h-100"},{default:r(()=>[o(h,{content:e.familyMap},null,8,["content"])]),_:1}),o(p,{value:"tree",class:"h-100"},{default:r(()=>[o(h,{content:e.familyTree},null,8,["content"])]),_:1}),o(p,{value:"chat"},{default:r(()=>[e.familyChat?(i(),s($,{key:0,chatId:e.familyChat,readOnly:e.readOnly,onSummaryNeedsUpdate:T},null,8,["chatId","readOnly"])):y("",!0)]),_:1})]),_:1},8,["modelValue"])]),_:1})]),_:1}),e.needsUpdate?(i(),s(V,{key:0,class:"me-2 mb-2 floating",elevation:"12",onClick:C,color:"primary"},{default:r(()=>[e.processingUpdate?(i(),s(x,{key:0,indeterminate:"",size:"small"})):(i(),s(l,{key:1,icon:"mdi-sync",size:"x-large"})),m("  Update Family ")]),_:1})):y("",!0)]),_:1})}}}),G=S(q,[["__scopeId","data-v-d616ab4b"]]);export{G as default};
