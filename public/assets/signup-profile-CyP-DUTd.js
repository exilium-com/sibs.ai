import{d as z,u as I,a as A,n as W,L,l as s,m as R,x as Y,c as x,w as o,r as c,b,e as t,$ as X,y as i,N as j,g as y,A as V,z as H,f as g,ac as J,a0 as K,q as Q,t as Z,ad as ee}from"./main-_0WdI2da.js";import{r as _}from"./form-validation-Bhn6uNEO.js";import{_ as te,a as oe}from"./date-field.vue_vue_type_script_setup_true_lang-SxS5M4GE.js";import{_ as ae,a as ne}from"./primary-button.vue_vue_type_script_setup_true_lang-D9N2jzjA.js";const le=g("br",null,null,-1),ie={class:"text-grey mt-3"},re={class:"text-grey mt-3"},se=g("br",null,null,-1),de=15*60,ye=z({__name:"signup-profile",setup(me){var N,M,O,S,w,U;const{user:l}=I(),$=A(),m=W(),E=L(()=>{var r,a,u;return e.otpVerified||((r=l==null?void 0:l.value)==null?void 0:r.email)&&((a=l==null?void 0:l.value)==null?void 0:a.email_verified)||((u=m.person)==null?void 0:u.validation)==="Verified"});s.debug(s.context(),"person = ",m.person);const e=R({movingToOtherStep:!1,formOk:!1,myGivenName:((N=m.person)==null?void 0:N.given_name)??"",myFamilyName:((M=m.person)==null?void 0:M.family_name)??"",myEmail:((O=m.person)==null?void 0:O.email)??"",myPhone:((S=m.person)==null?void 0:S.phone)??"",myBirthDate:(w=m.person)!=null&&w.birth_date?new Date((U=m.person)==null?void 0:U.birth_date):void 0,sentCodeCount:0,codeTimeout:void 0,codeTimeoutStep:1,codeExpirationMsg:"",otp:"",otpErrorMsgs:{title:"",text:""},checkingOTP:!1,otpVerified:!1,otpControl:null,formControl:null,resending:!1});Y(()=>e.codeTimeout,async()=>{if(s.debug(s.context(),"codeTimeout changed to ",e.codeTimeout),e.codeTimeout!==void 0)if(e.codeTimeout<=0)s.debug(s.context(),"codeTimeout expired"),e.codeExpirationMsg="That code has expired.",e.codeTimeout=-1;else{if(e.codeTimeout>59){const r=Math.round(e.codeTimeout/60);e.codeExpirationMsg=`Your code will expire in ${r} minute${r>1?"s":""}.`,e.codeTimeoutStep=30}else e.codeExpirationMsg=`Your code will expire in ${e.codeTimeout} seconds.`,e.codeTimeoutStep=1;setTimeout(()=>{e.codeTimeout&&(e.codeTimeout-=e.codeTimeoutStep)},e.codeTimeoutStep*1e3)}},{immediate:!0}),Y(()=>e.otp,()=>{e.otp=e.otp.toUpperCase()});async function P(){var r,a,u,d,p;s.debug(s.context(),"otp changed to ",e.otp);try{e.checkingOTP=!0,(r=e.otpControl)==null||r.blur();const{response:v}=await Q("/api/person/me/verify",{body:{email:(a=l==null?void 0:l.value)!=null&&a.email?null:e.myEmail,code:e.otp}});v.status==200||v.status==204?((u=e.formControl)==null||u.validate(),e.otpVerified=!0):(e.otpErrorMsgs={title:"Invalid code",text:""},(d=e.otpControl)==null||d.reset(),(p=e.otpControl)==null||p.focus())}finally{e.checkingOTP=!1}}function F(){e.movingToOtherStep=!0,Z("/api/person/me",{body:{given_name:e.myGivenName||void 0,family_name:e.myFamilyName||void 0,birth_date:e.myBirthDate?e.myBirthDate.toISOString().substr(0,10):void 0,phone:e.myPhone||void 0}}).then(()=>{s.debug(s.context(),"going to verify"),$.push({name:"authorized"})}).catch(r=>s.error(s.context(),r)).finally(()=>{e.movingToOtherStep=!1})}async function k(){var r;s.debug(s.context(),"resend");try{e.resending=!0,await ee((r=l==null?void 0:l.value)!=null&&r.email?void 0:e.myEmail)?(e.sentCodeCount++,e.codeTimeout=de):e.otpErrorMsgs={title:"Error",text:"Failed to send email"}}finally{e.resending=!1}}return(r,a)=>{const u=c("v-text-field"),d=c("v-col"),p=c("v-row"),v=c("v-icon"),q=c("v-btn"),C=c("v-card-text"),h=c("v-card"),B=c("v-container"),G=c("v-form");return b(),x(B,{class:"v-col-sm-9 v-col-lg-6 v-col-xl-4 pa-0 mt-4"},{default:o(()=>{var D;return[t(h,null,X({title:o(()=>[y("About you")]),subtitle:o(()=>{var n;return[y(V((n=i(l))==null?void 0:n.email),1)]}),default:o(()=>[t(G,{ref:n=>{e.formControl=n},modelValue:e.formOk,"onUpdate:modelValue":a[9]||(a[9]=n=>e.formOk=n)},{default:o(()=>[t(B,null,{default:o(()=>[t(p,null,{default:o(()=>[t(d,null,{default:o(()=>[t(u,{type:"text",label:"Your first name",id:"myGivenName",modelValue:e.myGivenName,"onUpdate:modelValue":a[0]||(a[0]=n=>e.myGivenName=n),rules:[i(_).required,i(_).name],required:""},null,8,["modelValue","rules"])]),_:1}),t(d,null,{default:o(()=>[t(u,{type:"text",label:"Your last name",id:"myFamilyName",modelValue:e.myFamilyName,"onUpdate:modelValue":a[1]||(a[1]=n=>e.myFamilyName=n),rules:[i(_).required,i(_).name],required:""},null,8,["modelValue","rules"])]),_:1})]),_:1}),t(p,{"no-gutters":""},{default:o(()=>[t(d,null,{default:o(()=>[t(te,{type:"tel",id:"myPhone",label:"Your phone number",modelValue:e.myPhone,"onUpdate:modelValue":a[2]||(a[2]=n=>e.myPhone=n),help:"Your phone number enables us to enhance our communication. We don't share your phone number with anyone.",rules:[i(_).phoneOrBlank]},null,8,["modelValue","rules"])]),_:1})]),_:1}),t(p,{"no-gutters":""},{default:o(()=>[t(d,null,{default:o(()=>[t(oe,{label:"Your birth date","min-date":-100*365,"max-date":0,id:"myBirthDate",help:"Your date of birth enables us to enhance our communication. We don't share your date of birth.",date:e.myBirthDate,"onUpdate:date":a[3]||(a[3]=n=>e.myBirthDate=n)},null,8,["date"])]),_:1})]),_:1}),t(p,{"no-gutters":""},{default:o(()=>[t(d,null,{default:o(()=>{var n;return[(n=i(l))!=null&&n.email?H("",!0):(b(),x(u,{key:0,label:"Your email",id:"myEmail",modelValue:e.myEmail,"onUpdate:modelValue":a[4]||(a[4]=T=>e.myEmail=T),rules:[i(_).required,i(_).email]},null,8,["modelValue","rules"])),e.sentCodeCount===0?(b(),x(h,{key:1,variant:"tonal",density:"compact"},{default:o(()=>[t(C,{class:"text-center"},{default:o(()=>[t(v,{icon:"mdi-alert-circle-outline",size:"large"}),y("   Your email is not confirmed yet     "),t(q,{disabled:!e.myEmail,class:"mt-4",elevation:"3",variant:"tonal",block:"",onClick:k,loading:e.resending},{default:o(()=>[y("Send email confirmation code")]),_:1},8,["disabled","loading"])]),_:1})]),_:1})):E.value?(b(),x(h,{key:3,variant:"tonal"},{default:o(()=>[t(C,null,{default:o(()=>[t(p,null,{default:o(()=>[t(d,{cols:"auto",class:"align-self-center"},{default:o(()=>[t(v,{icon:"mdi-email-seal",size:"xx-large"})]),_:1}),t(d,{class:"text-left"},{default:o(()=>[g("span",null,V(e.myEmail)+" is confirmed",1),se]),_:1}),t(d,{cols:"auto",class:"align-self-center"},{default:o(()=>[t(ne,{disabled:!e.formOk||!E.value,onClick:F,loading:e.movingToOtherStep},{default:o(()=>[y("Continue")]),_:1},8,["disabled","loading"])]),_:1})]),_:1})]),_:1})]),_:1})):(b(),x(h,{key:2,disabled:!e.myEmail,variant:"tonal",density:"compact"},{default:o(()=>[t(C,{class:"text-center"},{default:o(()=>{var T;return[t(v,{icon:"mdi-email",size:"large"}),y("   Check your email    "),le,g("div",ie," Enter the 6-letter code we sent to "+V((T=i(l))==null?void 0:T.email)+". ",1),t(i(J),{ref:f=>{e.otpControl=f},autofocus:"",modelValue:e.otp,"onUpdate:modelValue":a[5]||(a[5]=f=>e.otp=f),onFinish:a[6]||(a[6]=f=>P()),loading:e.checkingOTP,type:"text",placeholder:"-"},null,8,["modelValue","loading"]),t(ae,{"error-title":e.otpErrorMsgs.title,"onUpdate:errorTitle":a[7]||(a[7]=f=>e.otpErrorMsgs.title=f),"error-msg":e.otpErrorMsgs.text,"onUpdate:errorMsg":a[8]||(a[8]=f=>e.otpErrorMsgs.text=f)},null,8,["error-title","error-msg"]),g("div",re,[y(V(e.codeExpirationMsg)+" If you didn't receive it, please click ",1),g("a",{href:"#",onClick:K(k,["prevent"])},"here"),y(" to send a new one. ")])]}),_:1})]),_:1},8,["disabled"]))]}),_:1})]),_:1})]),_:1})]),_:1},8,["modelValue"])]),_:2},[(D=i(l))!=null&&D.picture?{name:"prepend",fn:o(()=>{var n;return[t(j,{picture:(n=i(l))==null?void 0:n.picture,firstName:e.myGivenName,lastName:e.myFamilyName,badge:i(m).invitationCount>0?i(m).invitationCount:void 0},null,8,["picture","firstName","lastName","badge"])]}),key:"0"}:void 0]),1024)]}),_:1})}}});export{ye as default};
